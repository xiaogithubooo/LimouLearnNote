>   前要：有些时候我们不得不使用内务穿透工具，这里推荐 [最著名的内外穿透工具 frp](https://github.com/fatedier/frp)，我们可以 [根据这个文档来学习怎么使用 frp 来做穿透](https://gofrp.org/zh-cn/docs/)，首先您必须要知道内网穿透的原理是什么，否则您可能从一开始就不清楚我们需要做什么。

# 1.frp 的安装运行

[直接获取其对应的二进制文件即可](https://gofrp.org/zh-cn/docs/setup/)，而这里我以 `Ubuntu` 为例子，使用 `wget` 进行安装，并且在 `Ubuntu` 上尝试运行。

```shell
# 安装和运行 frp
# 安装 frp
$ wget https://github.com/fatedier/frp/releases/download/v0.60.0/frp_0.60.0_linux_amd64.tar.gz

$ tar -zxvf frp_0.60.0_linux_amd64.tar.gz

$ mv frp_0.60.0_linux_amd64 frp

$ cd frp

# 配置 frp
$ ls
frpc  frpc.toml  frps  frps.toml  LICENSE

$ cat frpc.toml frps.toml # 不过我们按照默认的即可, 我们只在本地稍微测试一下就行
serverAddr = "127.0.0.1" # 服务端自己的公网 ip
serverPort = 7000 # 服务端允许的代理端口号

[[proxies]]
name = "test-tcp" # 客户端名称
type = "tcp" # 采用的代理协议
localIP = "127.0.0.1" # 本地服务器占用的 ip
localPort = 22 # 本地服务器占用的 port
remotePort = 6000 # 
bindPort = 7000

# 运行 frp
$ ./frps -c ./frps.toml & # 使用以下命令启动服务器
[1] 558528
2024-09-09 00:18:12.920 [I] [frps/root.go:105] frps uses config file: ./frps.toml
2024-09-09 00:18:13.171 [I] [server/service.go:237] frps tcp listen on 0.0.0.0:7000
2024-09-09 00:18:13.172 [I] [frps/root.go:114] frps started successfully

$ ./frpc -c ./frpc.toml # 使用以下命令启动客户端
2024-09-09 00:21:01.337 [I] [sub/root.go:142] start frpc service for config file [./frpc.toml]
2024-09-09 00:21:01.337 [I] [client/service.go:295] try to connect to server...
2024-09-09 00:21:01.342 [I] [server/service.go:576] [42307efebbdeb377] client login info: ip [127.0.0.1:48018] version [0.60.0] hostname [] os [linux] arch [amd64]
2024-09-09 00:21:01.342 [I] [client/service.go:287] [42307efebbdeb377] login to server success, get run id [42307efebbdeb377]
2024-09-09 00:21:01.342 [I] [proxy/proxy_manager.go:173] [42307efebbdeb377] proxy added: [test-tcp]
2024-09-09 00:21:01.343 [I] [proxy/tcp.go:82] [42307efebbdeb377] [test-tcp] tcp proxy listen port [6000]
2024-09-09 00:21:01.343 [I] [server/control.go:399] [42307efebbdeb377] new proxy [test-tcp] type [tcp] success
2024-09-09 00:21:01.343 [I] [client/control.go:168] [42307efebbdeb377] [test-tcp] start proxy success
```

可以看到安装成功了，不过我们一般都是直接使用 `systemd` 来管理服务端的，而客户端则交给用户在任意环境进行使用。不过，这需要您配置一下，根据官方文档所编写的配置即可。

```toml
# 创建 frps.service 文件
# 编写配置文件
$ sudo vim /etc/systemd/system/frps.service
[Unit]
# 服务名称，可自定义
Description = frp server
After = network.target syslog.target
Wants = network.target

[Service]
Type = simple
# 启动frps的命令，需修改为您的frps的安装路径
ExecStart = /path/to/frps -c /path/to/frps.toml

[Install]
WantedBy = multi-user.target

```

然后也是四套经典的 `systemd` 管理指令来进行管理。

```shell
# 管理 frps 服务
# 启动 frp
sudo systemctl start frps
# 停止 frp
sudo systemctl stop frps
# 重启 frp
sudo systemctl restart frps
# 查看 frp 状态
sudo systemctl status frps
# 设置 frps 开机自启动
sudo systemctl enable frps

```

到此检测安装成功。

# 2.frp 的工作原理

`frp` 主要由两个组件组成：`客户端(frpc)` 和 `服务端(frps)`。通常情况下，服务端部署在具有公网 `IP` 地址的机器上，而客户端部署在需要穿透的内网服务所在的机器上。

由于内网服务缺乏公网 `IP` 地址，因此无法直接被非局域网内的用户访问。用户通过访问服务端的 `frps`，`frp` 负责根据请求的端口或其他信息将请求路由到相应的内网机器，从而实现从局域网外的计算机向局域网进行通信。

在 `frp` 中，一个代理对应一个需要公开访问的内网服务。一个客户端可以同时配置多个代理，以满足不同的需求。

`frp` 支持多种代理类型，以适应不同的使用场景。以下是一些常见的代理类型：

*   **TCP**：提供纯粹的 `TCP` 端口映射，使服务端能够根据不同的端口将请求路由到不同的内网服务。
*   **UDP**：提供纯粹的 `UDP` 端口映射，与 `TCP` 代理类似，但用于 `UDP` 流量。
*   **HTTP**：专为 `HTTP` 应用设计，支持修改 `Host Header` 和增加鉴权等额外功能。
*   **HTTPS**：类似于 `HTTP` 代理，但专门用于处理 `HTTPS` 流量。
*   **STCP**：提供安全的 `TCP` 内网代理，要求在被访问者和访问者的机器上都部署 `frpc`，不需要在服务端暴露端口。
*   **SUDP**：提供安全的 `UDP` 内网代理，与 `STCP` 类似，需要在被访问者和访问者的机器上都部署 `frpc`，不需要在服务端暴露端口。
*   **XTCP**：点对点内网穿透代理，与 `STCP` 类似，但流量不需要经过服务器中转。
*   **TCPMUX**：支持服务端 `TCP` 端口的多路复用，允许通过同一端口访问不同的内网服务。

每种代理类型适用于不同的使用情境，您可以根据需求选择合适的代理类型来配置 `frp`。

>   补充：代理协议原理，待补充...

# 3.frp 的实践过程

首先需要准备三台机器，我这里以及有：

- 一台具有公网 `ip` 的 `Ubuntu20` 服务器 `public_server`
- 一台我自己组件子网的 `Ubuntu24` 电脑 `private_server`
- 一台直连运行商 `4G` 网络的本地 `apple` 电脑 `self_server`

此时 `private_server` 和 `self_server` 都可以访问 `public_server`，但是 `self_server` 无法访问到 `private_server`。 

我们此时要做到的就是 `self_server` 可以成功借助 `public_server` 访问到 `private_server`。



## 3.1.通过 ssh 访问内网机器

```shell
# 在具有公网 ip 的服务器中修改 frp 服务端配置
$ ls
frpc  frpc.toml  frps  frps.toml  LICENSE

$ cat ./frps.toml
serverAddr = "127.0.0.1"
serverPort = 7000
```

