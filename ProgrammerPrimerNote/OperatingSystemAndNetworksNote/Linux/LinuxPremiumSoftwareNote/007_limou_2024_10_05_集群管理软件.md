>   èµ„æ–™ï¼š
>
>   https://www.bilibili.com/video/BV1w4411y7Go/?vd_source = c92c89dbfcf9cc30c48086469621f35b è§†é¢‘
>
>   https://minikube.sigs.k8s.io/docs/tutorials/ æ•™ç¨‹
>
>   https://minikube.sigs.k8s.io/docs/handbook/ æ‰‹å†Œ

# 1.é›†ç¾¤ç®¡ç†çš„å†å²å‘å±•

é›†ç¾¤ç®¡ç†ï¼ˆèµ„æºç®¡ç†ï¼‰= Apche MESOSï¼ˆå¼€æºåˆ†å¸ƒå¼ç®¡ç†æ¡†æ¶ï¼Œè¢«æ¨ç‰¹ä½¿ç”¨ï¼‰-> Apche MESOS å¹³å°ç®¡ç† Kubernetesï¼Œå¯ä»¥ç»“åˆä½¿ç”¨-> Docker Swarmï¼ˆéå¸¸è½»é‡ï¼Œä¸“ä¸º docker å®¹å™¨å‡†å¤‡ï¼Œä½†æ˜¯ä¾æ—§ä¸å¦‚ k8sï¼ŒåŠŸèƒ½å¯¹äºä¼ä¸šè¿‡äºå±€é™ï¼Œä½†æ˜¯ä¸æ˜¯ä¸å¥½ç”¨ï¼Œæœ‰ä¸€ä¸ªäººé€šè¿‡æèµ å¾—åˆ°äº†ä¸€ä¸ªä¸Šåƒä¸‡çš„é›†ç¾¤ï¼Œå¯ä»¥æœç´¢ä¸€ä¸‹ï¼‰-> Kubernetesï¼ˆç”±è°·æ­Œå†…éƒ¨çš„ borg ä½¿ç”¨ go ç¿»å†™è€Œæ¥ï¼Œæœ¬èº«ä¹Ÿæ˜¯è½»é‡çº§ï¼Œå¼€æºï¼Œå¼¹æ€§ä¼¸ç¼©ï¼Œè‡ªåŠ¨è´Ÿè½½å‡è¡¡ï¼Œæ”¯æŒ `IPVS`ï¼‰ã€‚

å¾…è¡¥å……...

# 2.é›†ç¾¤ç®¡ç†çš„ç›¸å…³é…ç½®

æ‚¨å¿…é¡»å…ˆä¸‹è½½ `Docker` åå†æ¥ [æ ¹æ®å®˜æ–¹æ–‡æ¡£ä¸‹è½½ä¸€äº›å¿…è¦å·¥å…·](https://kubernetes.io/docs/tasks/tools/)ï¼Œç»Ÿä¸€ä¸‹è½½åæˆ‘ä»¬å†æ¥è¿›è¡Œç ”ç©¶ã€‚

```shell
# ä¸‹è½½ kubectl é›†ç¾¤ç®¡ç†å·¥å…·
sudo apt-get install -y apt-transport-https ca-certificates curl gnupg

curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.31/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

sudo chmod 644 /etc/apt/keyrings/kubernetes-apt-keyring.gpg

echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.31/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list

sudo chmod 644 /etc/apt/sources.list.d/kubernetes.list

sudo apt-get update

sudo apt-get install -y kubectl

```

```shell
# ä¸‹è½½ kubeadm é›†ç¾¤æ„å»ºå·¥å…·
sudo apt install -y apt-transport-https ca-certificates curl
curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
cat << EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list
deb https://apt.kubernetes.io/ kubernetes-xenial main
EOF

sudo apt update
sudo apt install -y kubelet kubeadm kubectl
sudo swapoff -a # æ°¸ä¹… sudo nano /etc/fstab æ³¨é‡Šæ‰ "# /swapfile none swap sw 0 0"
sudo kubeadm init --pod-network-cidr=10.244.0.0/16
```

```shell
# ä¸‹è½½ minikube é›†ç¾¤æ„å»ºå·¥å…·
curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube_latest_amd64.deb

sudo dpkg -i minikube_latest_amd64.deb

minikube version
minikube version: v1.34.0
commit: 210b148df93a80eb872ecbeb7e35281b3c582c61
```

```shell
# ä¸‹è½½ kind é›†ç¾¤æ„å»ºå·¥å…·
wget https://golang.org/dl/go1.20.linux-amd64.tar.gz

sudo tar -C /usr/local -xzf go1.20.linux-amd64.tar.gz

echo 'export PATH=$PATH:/usr/local/go/bin' >> ~/.bashrc # çœ‹ç»ˆç«¯

source ~/.bashrc

go version

go install sigs.k8s.io/kind@v0.24.0

echo 'export PATH=$PATH:$(go env GOPATH)/bin' >> ~/.bashrc
source ~/.bashrc

kind --version
kind version 0.24.0

```

ç®€å•æåŠä¸€ä¸‹ï¼Œ`kubeadm`ã€`minilube`ã€`kind` å¯ä»¥æä¾› `k8s` é›†ç¾¤ç¯å¢ƒï¼ˆç›¸å½“äºé›†ç¾¤è„šæ‰‹æ¶ï¼‰ï¼Œè€Œ `kubectl` è´Ÿè´£æ“ä½œå’Œç®¡ç†è¯¥ `k8s` é›†ç¾¤çš„èµ„æºï¼Œæ˜¯ä¸‰ä¸ªä¸åŒè„šæ‰‹æ¶çš„åº•å±‚å·¥å…·ã€‚

-   **Minikube**
    -   **å•èŠ‚ç‚¹æµ‹è¯•**ï¼šæ˜¯ä¸€æ¬¾å…è®¸ç”¨æˆ·è¿è¡Œä»…åŒ…å«å•ä¸ªèŠ‚ç‚¹çš„ `Kubernetes` é›†ç¾¤çš„è½¯ä»¶ã€‚è®¾ç½®é€Ÿåº¦ç›¸å½“å¿«ï¼Œå¹¶ä¸ºå¼€å‘äººå‘˜æä¾›äº†ä¸€ä¸ªå®Œç¾çš„æµ‹è¯•ç¯å¢ƒï¼Œä»¥äº†è§£ä»–ä»¬çš„å®¹å™¨åŒ–åº”ç”¨ç¨‹åºå¦‚ä½•åœ¨ `Kubernetes` ä¸Šè¿è¡Œã€‚å®ƒä¸é€‚ç”¨äºç”Ÿäº§ï¼Œè€Œæ˜¯åœ¨å°†åº”ç”¨ç¨‹åºå’Œéƒ¨ç½²è®¾ç½®å‘é€åˆ°ç”Ÿäº§ç¯å¢ƒä¹‹å‰æµ‹è¯•å®ƒä»¬çš„è¡¨ç°ã€‚
    -   **æ˜“äºä½¿ç”¨ï¼š**ä¸å…¶ä»– `Kubernetes` å·¥å…·ç›¸æ¯”ï¼Œ`minikube` æ˜“äºä½¿ç”¨å’Œåˆå§‹è®¾ç½®ã€‚å®ƒé™„å¸¦äº†è®¸å¤šå¼€ç®±å³ç”¨çš„é…ç½®è®¾ç½®ï¼Œå› æ­¤æ‚¨å¯ä»¥å¿«é€Ÿä¸Šæ‰‹ã€‚
    -   **å¼€å‘**ï¼š`Minikube` éå¸¸é€‚åˆéœ€è¦åœ¨å°†å®¹å™¨æˆ–éƒ¨ç½²æŠ•å…¥ç”Ÿäº§ä¹‹å‰å¯¹å…¶è¿›è¡Œæµ‹è¯•çš„å¼€å‘äººå‘˜ã€‚æŒ‰ç…§ç›¸åŒçš„é€»è¾‘ï¼Œå¯¹äº `Kubernetes` ç®¡ç†å‘˜æ¥è¯´ï¼Œåœ¨å°†è®¾ç½®æ¨é€åˆ°ç”Ÿäº§ `Kubernetes` é›†ç¾¤ï¼ˆä¾‹å¦‚ `kubeadm`ï¼‰ä¹‹å‰æŸ¥çœ‹æŸäº›å†…å®¹çš„è¿è¡Œæƒ…å†µä¹Ÿå¾ˆæœ‰ç”¨ã€‚
    -   **å­¦ä¹ **ï¼šå¯¹äºæƒ³è¦æ„å»º `Kubernetes` é›†ç¾¤çš„æ–°æ‰‹æ¥è¯´ï¼Œ`Minikube` æ˜¯ä¸€ä¸ªå®Œç¾çš„èµ·ç‚¹ã€‚å®ƒä¸ºæˆ‘ä»¬æä¾›äº†æ‰“åŒ…å®¹å™¨åŒ–åº”ç”¨ç¨‹åºæ‰€éœ€çš„æ‰€æœ‰å·¥å…·ï¼Œå°†å…¶ä½œä¸º `Pod` å¯åŠ¨ï¼Œç„¶åé€šè¿‡ `kubectl` å‘½ä»¤ä½¿ç”¨éƒ¨ç½²è®¾ç½®ã€‚
    -   **èŒƒå›´æœ‰é™ï¼š**ç”±äº `minikube` ä»…ç”¨äºå¼€å‘å’Œæµ‹è¯•ç›®çš„ï¼Œå› æ­¤å®ƒåªæ˜¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¸ç›´æ¥è¿è¡Œå®¹å™¨ç›¸æ¯”ï¼Œé€šè¿‡ `minikube` è¿è¡Œ `Kubernetes` ä¸ä¼šå¸¦æ¥å¤ªå¤šå¥½å¤„ã€‚å°è¯•åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨å®ƒåŸºæœ¬ä¸Šæ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚ 
    -   **æ€§èƒ½ï¼š**é€šè¿‡ `minikube` è¡¡é‡å®¹å™¨åŒ–åº”ç”¨ç¨‹åºæˆ–æˆç†Ÿçš„ `Kubernetes` é›†ç¾¤çš„å®é™…æ€§èƒ½å¯èƒ½å¾ˆå›°éš¾ï¼Œå› ä¸ºå®ƒåªæ˜¯å•ä¸ªèŠ‚ç‚¹ï¼Œå¹¶ä¸”ä¸å…·å¤‡ `kubeadm` ç­‰ä¸åŒ `Kubernetes` å·¥å…·çš„è®¸å¤šåŠŸèƒ½ã€‚å½“è¿è¡Œèµ„æºå¯†é›†å‹åº”ç”¨ç¨‹åºæ—¶ï¼Œæ‚¨æ›´æœ‰å¯èƒ½çœ‹åˆ° `minikube` çš„æ€§èƒ½ä¸‹é™ã€‚
-   **Kubeadm**
    -   **ç”Ÿäº§å°±ç»ª**ï¼š`Kubeadm` é€šå¸¸ç”¨äºç”Ÿäº§ç¯å¢ƒï¼Œä¾‹å¦‚å…¬å¸çš„ `Web` æœåŠ¡å™¨æ¯å¤©éœ€è¦å¤„ç†æ•°ç™¾ä¸‡æ¬¡è®¿é—®ã€‚å®ƒé…å¤‡äº†å¤§è§„æ¨¡å¯åŠ¨å®¹å™¨åŒ–åº”ç”¨ç¨‹åºæ‰€éœ€çš„æ‰€æœ‰å·¥å…·ï¼Œå¹¶å…è®¸ç®¡ç†å‘˜ç®¡ç†å‡ ä¹æ— é™çš„èŠ‚ç‚¹å’Œ `Pod`ã€‚ç»è¿‡å¼€å‘å•†å’Œä¼ä¸šçš„å……åˆ†æµ‹è¯•ï¼Œæ»¡è¶³ä»–ä»¬çš„éœ€æ±‚ã€‚
    -   **å¯å®šåˆ¶**ï¼š`kubeadm` çš„è®¸å¤šæ–¹é¢éƒ½å¯ä»¥å®šåˆ¶ï¼Œä»¥æ»¡è¶³ `Kubernetes` é›†ç¾¤çš„éœ€æ±‚ã€‚ç”šè‡³ `API` æœåŠ¡å™¨ã€`etcd` å’Œ `kubelet` ç­‰æ ¸å¿ƒç»„ä»¶ä¹Ÿå¯ä»¥æ ¹æ®ä¸åŒçš„éœ€æ±‚è¿›è¡Œé…ç½®å’Œé™åˆ¶ã€‚è¿™ä½¿å¾— `kubeadm` æˆä¸ºæ˜“äºéšæ—¶é—´å˜åŒ–çš„ `Kubernetes` é›†ç¾¤çš„æ˜æ™ºé€‰æ‹©ã€‚
    -   **ç®¡ç†**ï¼š`Kubeadm` å…è®¸å¯¹ `Kubernetes` é›†ç¾¤ä¸­çš„å„ä¸ªæ–¹é¢è¿›è¡Œå¾®è°ƒç®¡ç†ã€‚æ‚¨å¯ä»¥é€‰æ‹©è¦ä½¿ç”¨å“ªç§ç±»å‹çš„ç½‘ç»œé™„åŠ ç»„ä»¶ï¼Œå¯ä»¥é…ç½®èº«ä»½éªŒè¯ä»¥åŠè®¸å¤šå…¶ä»–è®¾ç½®æ¥æ»¡è¶³æ‚¨çš„ä¸ªäººé›†ç¾¤çš„éœ€æ±‚ã€‚
    -   **å¤æ‚æ€§**ï¼š`Kubeadm` çš„å­¦ä¹ æ›²çº¿å¾ˆé™¡å³­ï¼Œä¸å»ºè®® `Kubernetes` æ–°æ‰‹æˆ–é‚£äº›ä¸€å¼€å§‹å°±ä¸å¤ªäº†è§£å®¹å™¨åŒ–ç¼–æ’å·¥ä½œåŸç†çš„äººä½¿ç”¨ã€‚å®ƒæ˜¯ä¸€ä¸ªå¤æ‚çš„è½¯ä»¶ï¼Œéœ€è¦é…ç½®è®¸å¤šè®¾ç½®ï¼Œå¹¶ä¸”æ²¡æœ‰å¤ªå¤šæŒ‡ç¤ºä½•æ—¶æˆ–ä¸ºä½•å‡ºç°é—®é¢˜ï¼Œå› æ­¤ç®¡ç†å‘˜éœ€è¦è‡ªè¡Œæ’é™¤æ•…éšœã€‚ 
    -   **æ•…éšœæ’é™¤**ï¼šç”±äº `kubeadm` çš„å¤æ‚æ€§ï¼Œæ‚¨éœ€è¦ç»éªŒä¸°å¯Œçš„ç®¡ç†å‘˜æ¥è§£å†³å‡ºç°çš„é—®é¢˜ã€‚é€šè¿‡ `kubeadm` ç»´æŠ¤ `Kubernetes` é›†ç¾¤å¯èƒ½å…·æœ‰æŒ‘æˆ˜æ€§ä¸”è€—æ—¶ã€‚

>   è¡¥å……ï¼šä¸Šè¿°å‚è€ƒ[Linux ä¸­å›½ | kubeadm ä¸ minikube ä¼˜ç¼ºç‚¹](https://cn.linux-console.net/?p=9791)ã€‚

>   è¡¥å……ï¼šé™¤æ­¤ä»¥å¤–ï¼Œè¿˜æœ‰ä¸€äº›åˆ«çš„é›†ç¾¤è„šæ‰‹æ¶ï¼Œä¾‹å¦‚ `K3sã€Microk8s`ã€‚

è€Œè¿˜æœ‰ä¸ªæ¯”è¾ƒç¡¬ä¼¤çš„é—®é¢˜ï¼Œå°±æ˜¯ç‰©ç†æœºå™¨è¶Šå¤šè¶Šå¥½ï¼Œæˆ‘è¿™é‡Œæœ‰ `5` å°ç‰©ç†æœºå™¨å¯ä»¥ä¾›æˆ‘å®éªŒï¼Œä¸”éƒ½æ˜¯æœåŠ¡å™¨ã€‚

# 3.é›†ç¾¤ç®¡ç†çš„ç°ä»£æ ‡å‡†

## 3.1.k8s çš„å‰ä¸–ä»Šç”Ÿ

`k8s` å¯ä»¥è¯´æ˜¯ `Borg` çš„åŠ å¼ºç‰ˆæœ¬ï¼Œå¹¶ä¸”ä½¿ç”¨ `Go` é‡æ„è€Œæ¥ã€‚

![image-20241011235648406](./assets/image-20241011235648406.png)

ä¸Šå›¾å°±æ˜¯ `Borg` çš„è®¾è®¡æ¶æ„å›¾ã€‚`BorgMaster(ä¸»èŠ‚ç‚¹)` é€šè¿‡ `scheduler(è°ƒåº¦å™¨)`ï¼Œæ¥è¿›è¡Œè¯·æ±‚åˆ†å‘ï¼ˆå¹¶ä¸”ä¸€èˆ¬æ˜¯æœ‰å¤šä¸ªå‰¯æœ¬ï¼Œå¹¶ä¸”æœ€å¥½æ˜¯å¥‡æ•°èŠ‚ç‚¹ï¼Œé¿å…å‡ºç°â€œå¹³å±€â€çš„ç°è±¡ï¼‰ï¼Œè€Œå·¥ä½œçš„èŠ‚ç‚¹å°±æ˜¯ä¸€ç³»åˆ—çš„ `Borglet(å·¥ä½œèŠ‚ç‚¹)`ã€‚

è€Œè¿™é‡Œæœ‰ä¸‰ç§è®¿é—® `BorgMaster(ä¸»èŠ‚ç‚¹)` çš„ä¸»è¦æ–¹æ³•ï¼š

1.   é…ç½®æ–‡ä»¶è¯»å†™
2.   å‘½ä»¤è¡Œå·¥å…·è¯»å†™
3.   æµè§ˆå™¨è¯»å†™

å…¶ä¸­ `scheduler(è°ƒåº¦å™¨)` ä¸ä¼šç›´æ¥è®¿é—® `Borglet(å·¥ä½œèŠ‚ç‚¹)`ï¼Œè€Œæ˜¯å’Œ `Paxos(é”®å€¼å¯¹æ•°æ®åº“)` è¿›è¡Œäº¤äº’ï¼Œ`Borglet` å°±ä¼šä»è¿™ä¸ª `Paxos(é”®å€¼å¯¹æ•°æ®åº“)` å–å‡ºäº¤ç»™è‡ªå·±çš„è¯·æ±‚è¿›è¡Œæ¶ˆè´¹ã€‚

è€Œ `k8s` æ¶æ„å›¾å’Œä¸Šè¿°ç±»ä¼¼ã€‚

## 3.2.k8s çš„ç»„ä»¶æ¡†æ¶

![image-20241106235014862](./assets/image-20241106235014862.png)

ä¸Šå›¾å°±æ˜¯ `k8s` çš„è®¾è®¡æ¶æ„å›¾ï¼Œè¿™å…¶ä¸­æœ‰ä¸€äº› `Borg` çš„å½±å­ã€‚`scheduler(è°ƒåº¦å™¨)` ä¼šæŠŠä»»åŠ¡äº¤ç»™ `api server(æ¥å£æœåŠ¡)`ï¼Œ`api server(æ¥å£æœåŠ¡)` å†æŠŠè¯·æ±‚å†™å…¥åˆ° `etcd` åˆ†å¸ƒå¼æ•°æ®åº“ä¸­ã€‚`replication controller(æ§åˆ¶å™¨)` åˆ™ç”¨æ¥æ§åˆ¶ `api server(æ¥å£æœåŠ¡)` å‰¯æœ¬çš„æ•°é‡ï¼ˆæ­¤æ—¶å¯ä»¥åŠ¨æ€ä¿®æ”¹å‰¯æœ¬æ•°é‡ï¼Œå¹¶ä¸”æœ€å¥½ä¹Ÿæ˜¯è®¾ç½®å¥‡æ•°ä¸ªï¼Œé¿å…é€‰ä¸¾é—®é¢˜ï¼‰ã€‚

å› æ­¤è¿™é‡Œä¹Ÿæœ‰ä¸‰ç§è®¿é—® `api server(æ¥å£æœåŠ¡)` çš„ä¸»è¦æ–¹å¼ï¼š

-   `etcd`  åˆ†å¸ƒå¼é”®å€¼å¯¹å­˜å‚¨ç³»ç»Ÿè¯»å†™
-   `kubectl` ä¸“ç”¨å‘½ä»¤è¡Œå·¥å…·è¯»å†™
-   æµè§ˆå™¨è¯»å†™

è¿™é‡Œè¿˜å¯ä»¥ç»™å‡ºå…³äº `etcd` çš„æ¶æ„å›¾ã€‚

![image-20241012003048888](./assets/image-20241012003048888.png)

`etcd` å’Œ `MySQL` ä¸€æ ·éƒ½æ˜¯åŸºäº `C/S` æœåŠ¡å¼€å‘ï¼Œ`Raft` æ˜¯åˆ†å¸ƒå¼çš„é€‰ä¸¾ç®—æ³•ï¼Œé€šè¿‡é€‰ä¸¾é¢†å¯¼çš„æ–¹å¼æ¥å¤„ç†å†™å…¥è¯·æ±‚ã€‚è€Œä¸ºäº†é˜²æ­¢æ•°æ®æŸåï¼Œè¿˜é…å¤‡äº† `WAL` è¿™ç§æ—¥å¿—è®°å½•æœºåˆ¶ï¼Œé˜²æ­¢æ•°æ®çš„æ„å¤–ä¸¢å¤±ã€‚`Entry` è®°å½•æ—¥å¿—ä¸­çš„å•ä¸ªæ¡ç›®ï¼ŒåŒ…å«ä¸€ä¸ªæ“ä½œæˆ–çŠ¶æ€å˜æ›´çš„å…·ä½“ä¿¡æ¯ï¼Œä»£è¡¨ä¸€ä¸ªå¯¹çŠ¶æ€æœºçš„ä¿®æ”¹ã€‚`Snapshot` æ˜¯çŠ¶æ€æœºåœ¨æŸä¸€æ—¶åˆ»çš„å®Œæ•´å¿«ç…§ï¼ŒåŒ…å«å½“å‰æ‰€æœ‰æ•°æ®çš„çŠ¶æ€ï¼Œå¯ä»¥åœ¨ç³»ç»Ÿæ¢å¤æ—¶é¿å…é‡æ”¾æ‰€æœ‰çš„ `Entries`ã€‚æœ€åæ‰å®é™…å­˜å‚¨åœ¨ `Store` ä¸­è¿›è¡ŒæŒä¹…åŒ–ã€‚

>   è¡¥å……ï¼š`WAL(Write-Ahead Logging, é¢„å†™æ—¥å¿—)` æ˜¯ä¸€ç§ç”¨äºæ•°æ®æŒä¹…åŒ–çš„æ—¥å¿—è®°å½•æœºåˆ¶ã€‚åœ¨å†™å…¥æ•°æ®åº“ä¹‹å‰ï¼Œé¦–å…ˆå°†æ•°æ®å˜æ›´è®°å½•åˆ°æ—¥å¿—ä¸­ã€‚è¿™ç§æœºåˆ¶ç¡®ä¿äº†åœ¨ç³»ç»Ÿå´©æºƒæˆ–æ•…éšœåï¼Œå¯ä»¥é€šè¿‡å›æ”¾æ—¥å¿—æ¥æ¢å¤æ•°æ®çš„å®Œæ•´æ€§ã€‚
>
>   `WAL` çš„ä¸»è¦ä¼˜ç‚¹åŒ…æ‹¬ï¼š
>
>   1.  **æ•°æ®å®‰å…¨æ€§** åœ¨æ•°æ®å†™å…¥æ•°æ®åº“ä¹‹å‰ï¼Œå…ˆè®°å½•åˆ°æ—¥å¿—ä¸­ï¼Œå³ä½¿å‘ç”Ÿæ•…éšœï¼Œä¹Ÿèƒ½é€šè¿‡æ—¥å¿—æ¢å¤æ•°æ®
>   2.  **æ€§èƒ½æå‡** æ‰¹é‡å†™å…¥æ—¶ï¼Œå¯ä»¥å…ˆå°†æ—¥å¿—å†™å…¥å†…å­˜ï¼Œå‡å°‘ç£ç›˜ `I/O` æ“ä½œï¼Œæé«˜æ€§èƒ½
>   3.  **ä¸€è‡´æ€§** é€šè¿‡æ—¥å¿—ï¼Œç¡®ä¿æ•°æ®å˜æ›´æ“ä½œçš„é¡ºåºä¸€è‡´ï¼Œç»´æŠ¤æ•°æ®çš„ä¸€è‡´æ€§

>   è¡¥å……ï¼šç°åœ¨ `Etcd` è½¬è€Œä½¿ç”¨ `v3` ä»¥ä¸Šçš„ç‰ˆæœ¬ï¼Œå‰é¢çš„ç‰ˆæœ¬å·²ç»è¢«æŠ›å¼ƒï¼ˆ `v2` ç‰ˆæœ¬å‡ ä¹åªæŠŠæ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œ`v3` ç‰ˆæœ¬å¢åŠ äº†å…³äºå­˜å‚¨å·çš„æŒä¹…åŒ–æ–¹æ¡ˆï¼‰...

ä¸Šè¿°çš„æ‰€æœ‰é‡è¦ç»„ä»¶éƒ½å¯ä»¥çœ‹ä½œæ˜¯ `k8s` çš„ä¸»èŠ‚ç‚¹ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹æˆ‘ä»¬çš„å·¥ä½œèŠ‚ç‚¹ã€‚ä¸€ä¸ªå·¥ä½œèŠ‚ç‚¹å°±æ˜¯ä¸€ä¸ª `Node`ï¼Œå¤šä¸ªå·¥ä½œèŠ‚ç‚¹åŠ ä¸Šä¸»èŠ‚ç‚¹å°±æ˜¯ä¸€ä¸ª `k8s` é›†ç¾¤ã€‚è€Œ `Node` å†…éƒ¨åŒ…å« `Kubelet(CRI, å®¹å™¨/è¿è¡Œæ—¶ç¯å¢ƒ/æ¥å£, ä¼šç»´æŠ¤ api server å’Œ Docker å®¹å™¨çš„äº¤äº’å’Œæ“ä½œ, æ˜¯æœ¬èŠ‚ç‚¹çš„ç®¡ç†ä»£ç†è€…)` ã€`Kube proxy(è´Ÿè´£å¤„ç†é›†ç¾¤ä¸­ Pod çš„ç½‘ç»œæµé‡, æ”¯æŒ ipvs ä»¥åŠå¤šç§ä»£ç†æ¨¡å¼, é»˜è®¤çš„æ“ä½œå¯¹è±¡æ˜¯ firewail, ä¹Ÿå°±æ˜¯é˜²ç«å¢™å»å®ç° Pod çš„æ˜ å°„, è®¾ç½® IPTablesã€IPVS å®ç°æœåŠ¡æ˜ å°„è®¿é—®`ã€`Pods(æ¯ä¸ª Pod å†…éƒ¨åŒ…å«å¤šä¸ªå®¹å™¨, å¯ä»¥æ˜¯ Docker å®¹å™¨)`ã€‚

>   è¡¥å……ï¼š`k8s` æ¶æ„é‡Œçš„ `api server(æ¥å£æœåŠ¡)` éå¸¸ç¹å¿™ï¼ˆæ§åˆ¶å™¨ã€è°ƒåº¦å™¨ã€å‘½ä»¤è¡Œå·¥å…·ã€æµè§ˆå™¨ã€å­˜å‚¨ç³»ç»Ÿã€å®¹å™¨è¿è¡Œæ—¶æ¥å£ã€ç½‘ç»œä»£ç†éƒ½éœ€è¦è®¿é—®ï¼‰ï¼Œå› æ­¤æ¯ä¸ªç»„ä»¶ä¹Ÿå¯ä»¥åœ¨æœ¬åœ°ç”Ÿæˆä¸€å®šçš„ç¼“å­˜é™ä½ `api server(æ¥å£æœåŠ¡)` çš„å‹åŠ›ï¼ˆè¿™ç§ç¼“å­˜æœºåˆ¶å¯ä»¥ç”±å¤šç§æ–¹æ¡ˆè§£å†³ï¼Œæ¯”å¦‚è®¾ç½®ç¼“å­˜æœ‰æ•ˆæœŸ `TTL`ï¼Œç‰ˆæœ¬å·æ—¶é—´æˆ³ç¡®è®¤è¯·æ±‚ï¼ŒæœåŠ¡å™¨äº‹ä»¶é©±åŠ¨æœºåˆ¶...ï¼‰ã€‚ä¸è¿‡è¿™ä¹ˆè®²æœ‰äº›ç®€å•ï¼Œåé¢è¿˜ä¼šç»†ç»†è®²è§£...

>   è¡¥å……ï¼š`IPVS(IP Virtual Server)` æ˜¯ä¸€ä¸ª `Linux` å†…æ ¸æ¨¡å—ï¼Œæä¾›åŸºäº `IP` çš„è´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚å®ƒé€šè¿‡å°†å¤šä¸ªåç«¯æœåŠ¡å™¨ï¼ˆå¦‚ `Pod`ï¼‰ç»‘å®šåˆ°ä¸€ä¸ªè™šæ‹Ÿ `IP` åœ°å€ï¼Œå®ç°è´Ÿè½½å‡è¡¡ã€‚
>
>   ä¸»è¦ç‰¹ç‚¹åŒ…æ‹¬ï¼š
>
>   1.  **é«˜æ€§èƒ½**ï¼š`IPVS` åœ¨å†…æ ¸ä¸­å®ç°ï¼Œèƒ½å¤Ÿå¤„ç†å¤§é‡å¹¶å‘è¿æ¥ï¼Œæä¾›æ›´é«˜çš„æ€§èƒ½å’Œæ›´ä½çš„å»¶è¿Ÿã€‚
>   2.  **å¤šç§è´Ÿè½½å‡è¡¡ç®—æ³•**ï¼šæ”¯æŒå¤šç§è´Ÿè½½å‡è¡¡ç®—æ³•ï¼ˆå¦‚è½®è¯¢ã€æœ€å°‘è¿æ¥ã€åŠ æƒè½®è¯¢ç­‰ï¼‰ï¼Œå¯ä»¥æ ¹æ®ä¸åŒçš„åœºæ™¯é€‰æ‹©åˆé€‚çš„ç®—æ³•ã€‚
>   3.  **é›†æˆæ”¯æŒ**ï¼š`Kubernetes` ä¸­çš„ `Kube Proxy` å¯ä»¥é…ç½®ä¸ºä½¿ç”¨ `IPVS` æ¨¡å¼ï¼Œä»¥ä¾¿æ›´é«˜æ•ˆåœ°ç®¡ç†æœåŠ¡æµé‡ã€‚
>
>   é€šè¿‡è¿™äº›åŠŸèƒ½ï¼Œ`IPVS` å¯ä»¥åœ¨å¤§è§„æ¨¡çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æœ‰æ•ˆåœ°ç®¡ç†æµé‡ï¼Œæé«˜åº”ç”¨çš„å¯ç”¨æ€§å’Œå¯é æ€§ã€‚

ä¸»è¦ç»„ä»¶å¦‚ä¸Šï¼Œä½†æ˜¯è¿˜æœ‰ä¸€äº›éå¸¸é‡è¦çš„æ’ä»¶ä¹Ÿå€¼å¾—ä¸€æã€‚

- `CoreDNS` å¯ä»¥ä¸ºé›†ç¾¤ä¸­çš„æœåŠ¡ï¼ˆ`SVC, service, æœåŠ¡, åœ¨è¿™é‡Œä¹Ÿå°±æ˜¯ä¸€ä¸ª Pod å…¬å¼€ä¸ºç½‘ç»œæœåŠ¡`ï¼‰åˆ›å»ºä¸€ä¸ªåŸŸåæœåŠ¡å™¨ `IP` å¯¹åº”çš„è§£æ
- `Dashboard` å¯ä»¥ `k8s` æä¾›å…³äº `B/S` æ¶æ„çš„æ”¯æŒ
- `Ingress Controller` å¯ä»¥å®ç°ä¸ƒå±‚ä»£ç†ï¼ˆå®˜æ–¹åªå®ç°äº†å››å±‚ï¼‰
- `Fedetation` å¯ä»¥æä¾›è·¨é›†ç¾¤ä¸­å¿ƒå¤š `k8s` ç»Ÿä¸€ç®¡ç†åŠŸèƒ½
- `Prometheus` å¯ä»¥ `k8s` é›†ç¾¤çš„æ—¥å¿—ç»Ÿä¸€åˆ†æå¹³å°

## 3.3.k8s çš„èµ„æºæ¸…å•

åœ¨ `Kubernetes` ä¸­ï¼Œ**èµ„æºæ¸…å•** æŒ‡çš„æ˜¯ç”¨äºæè¿° `k8s` é›†ç¾¤ä¸­å„ç±»èµ„æºçš„å£°æ˜æ€§é…ç½®æ–‡ä»¶ï¼Œé€šå¸¸ä»¥ `YAML` æˆ– `JSON` æ ¼å¼ç¼–å†™ã€‚èµ„æºæ¸…å•å®šä¹‰äº†é›†ç¾¤ä¸­å·¥ä½œè´Ÿè½½ï¼ˆå¦‚ä½•è¿è¡Œã€å¦‚ä½•è¿›è¡Œç½‘ç»œé…ç½®ã€å¦‚ä½•ç®¡ç†å­˜å‚¨å’Œèµ„æºè°ƒåº¦ç­‰ã€‚å¸¸è§çš„èµ„æºæ¸…å•ç±»å‹ï¼š

1. **Pod**ï¼šæœ€å°çš„å¯è°ƒåº¦å•ä½ï¼ŒåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨
2. **Controller**ï¼š`Pod` çš„æ§åˆ¶å™¨ï¼Œç®¡ç† `Pod` çš„ç”Ÿå‘½å‘¨æœŸ
3. **Service**ï¼šå°†ä¸€ç»„ `Pod` å…¬å¼€ä¸ºç½‘ç»œæœåŠ¡ï¼Œå…è®¸å…¶ä»–æœåŠ¡æˆ–ç”¨æˆ·é€šè¿‡å›ºå®š `IP` è®¿é—®è¿™äº› `Pod`

æˆ‘ä»¬æ¥ä¸€ä¸ªä¸€ä¸ªä»‹ç»...

### 3.3.1.Pod

`Pod` ä¹Ÿå«åšå·¥ä½œè´Ÿè½½ï¼Œå¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼š

- è‡ªä¸»å¼ `Pod`ï¼Œç”Ÿå‘½å‘¨æœŸç»“æŸåæ²¡æœ‰å¤„ç†ç­–ç•¥
- æ§åˆ¶å™¨ `Pod`ï¼Œç”Ÿå‘½å‘¨æœŸç»“æŸåå­˜åœ¨å¤„ç†ç­–ç•¥

è€Œæ›´åŠ å‡†ç¡®æ¥è¯´ï¼Œ`Pod` åªè¦è¿è¡Œèµ·æ¥ï¼Œä¸€å®šæœ‰ä¸€ä¸ªå®¹å™¨è¢«è¿è¡Œèµ·æ¥ï¼Œè€Œå¦‚æœåç»­ `Pod` ä¸­åŠ å…¥äº†å…¶ä»–å®¹å™¨ï¼Œå°±å¿…é¡»ä¿è¯è¿™äº›å®¹å™¨ä½¿ç”¨ä¸€äº›ç›¸åŒçš„èµ„æºã€‚è¿™ç§åšæ³•å°±éœ€è¦ç”¨ä¸€ä¸ª `Pause` çˆ¶å®¹å™¨æ¥åšåˆ°ï¼Œå®ƒå°±ç›¸å½“äºå…¶ä»–å®¹å™¨çš„çˆ¶è¿›ç¨‹ï¼Œå¯ä»¥å…±äº«ç»™å¤šä¸ªå®¹å™¨è‡ªå·±ç®¡ç†çš„èµ„æºï¼ˆä¸€èˆ¬å…±äº«ç½‘ç»œã€å…±äº«å­˜å‚¨å·ï¼‰ã€‚

å› æ­¤é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ª `Pod` å†…éƒ¨çš„æ‰€æœ‰å®¹å™¨éƒ½å…±äº«ç›¸åŒçš„èµ„æºã€‚

ä¸€å°ä¸»æœºå°±è§†ä¸ºä¸€ä¸ªå·¥ä½œèŠ‚ç‚¹ `Node`ï¼Œå†…éƒ¨åŒ…å«å¤šä¸ª `Pod` èµ„æºï¼Œè¿™ç§è®¾è®¡ä¹Ÿæ–¹ä¾¿ä¸€å°ä¸»æœºä¹Ÿå¯ä»¥å®ç°åˆ†å¸ƒå¼æ¶æ„ã€‚

### 3.3.2.Controller

ç”±äº `Pod` æœ‰æ­»äº¡çš„é£é™©ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æŸäº›è‡ªåŠ¨åŒ–ç­–ç•¥ï¼Œæ§åˆ¶ `Pod` çš„ç”Ÿå‘½å‘¨æœŸï¼Œ[è€Œ K8s å®˜æ–¹æ–‡æ¡£ä¸­å®šä¹‰çš„  Pod çš„æ§åˆ¶å™¨](https://kubernetes.io/zh-cn/docs/concepts/workloads/) å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç§ï¼š

- **==é™æ€æ•°é‡+ç›´æ¥ç®¡ç†+æ— çŠ¶ç®¡ç† ReplicationController==**
  - `ReplicationController` æ˜¯ `k8s` æ—©æœŸç‰ˆæœ¬ä½¿ç”¨çš„æ§åˆ¶å™¨ï¼Œç”¨äºç¡®ä¿æŒ‡å®šæ•°é‡çš„ `Pod` å®ä¾‹åœ¨é›†ç¾¤ä¸­å§‹ç»ˆä¿æŒè¿è¡ŒçŠ¶æ€ï¼ˆå¤šåˆ™åˆ ï¼Œå°‘åˆ™å¢ï¼‰ï¼Œ[è¿™ç§æ§åˆ¶å™¨åœ¨å®˜æ–¹æ–‡æ¡£ä¸­å·²ç»è¢«å†™æ˜ä¸ºå¼ƒç”¨](https://kubernetes.io/zh-cn/docs/concepts/workloads/)ã€‚

- **==é™æ€æ•°é‡+æ ‡ç­¾ç®¡ç†+æ— çŠ¶ç®¡ç† ReplicaSet== **
  - `ReplicaSet` æ˜¯ `ReplicationController` çš„æ”¹è¿›ç‰ˆï¼ŒåŠŸèƒ½ç±»ä¼¼ï¼Œä½†æä¾›äº†æ›´çµæ´»çš„æ ‡ç­¾é€‰æ‹©å™¨ï¼ˆ`selectors`ï¼Œè¿™æ ·å°±å¯ä»¥ç»™ `Pod` æ‰“ä¸Šæ ‡ç­¾ï¼‰ã€‚å®ƒçš„ä½œç”¨ä¹Ÿæ˜¯ç»´æŒæŸä¸ªæŒ‡å®šæ•°é‡çš„ `Pod` å‰¯æœ¬ï¼ˆ`replicas`ï¼‰è¿è¡Œï¼Œå³ä½¿æŸäº› `Pod` å´©æºƒæˆ–åˆ é™¤ï¼Œ`ReplicaSet` ä¼šåˆ›å»ºæ–°çš„ `Pod` æ¥ç¡®ä¿å‰¯æœ¬æ•°æ’å®šï¼ˆä½†æ˜¯ä¸€èˆ¬è¿˜æ˜¯ä¼šè¦æ±‚ä½¿ç”¨äºŒåä¸€æ—¶å››åäº”åˆ† `Reployment` æ¥è‡ªåŠ¨ç®¡ç†ï¼Œå› ä¸ºæœ‰å¯èƒ½ `ReplicaSet` ä¸æ”¯æŒ `rolling-updata, æ»šåŠ¨æ›´æ–°`ï¼‰
- **==é™æ€æ•°é‡+æ ‡ç­¾ç®¡ç†+æ— çŠ¶ç®¡ç†+è‡ªåŠ¨å›æ»š Deployment== **
  - `Deployment` æ˜¯ä¸€ç§æ›´é«˜çº§çš„æ§åˆ¶å™¨ï¼Œç”¨äºç®¡ç†æ— çŠ¶æ€åº”ç”¨çš„éƒ¨ç½²ã€‚å®ƒé€šå¸¸ç”¨äºç®¡ç†åº”ç”¨çš„æ»šåŠ¨æ›´æ–°ã€å›æ»šã€æ‰©å±•å’Œå…¶ä»–è¿ç»´ä»»åŠ¡
  -  `Deployment` ä¼šåˆ›å»ºä¸€ä¸ª `ReplicaSet`ï¼Œå†ç”± `ReplicaSet` æ¥ç®¡ç† `Pod` çš„å‰¯æœ¬ï¼Œå¹¶ç”± `ReplicaSet` æä¾›æ›´æ–°å’Œç‰ˆæœ¬æ§åˆ¶çš„åŠŸèƒ½ï¼ˆå¯ä»¥æ–¹ä¾¿æ€æ‰åŸæœ¬çš„ `Pod`ï¼Œé‡æ–°å»ºç«‹æ–°æ ‡ç­¾ç‰ˆæœ¬çš„ `Pod`ï¼Œå¦‚æœæ­¤æ¬¡æ»šåŠ¨æ›´æ–°å¯¼è‡´ `bug`ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œç‰ˆæœ¬å›æ»šï¼‰
- **==åŠ¨æ€æ•°é‡+æ ‡ç­¾ç®¡ç†+æ— çŠ¶ç®¡ç† Horizontal Pod Autoscaler== **
  - `HPA` æ ¹æ®ç”¨æˆ·å®šä¹‰çš„æŒ‡æ ‡ï¼ˆé€šå¸¸æ˜¯æŒ‡ `Pod` çš„ `CPU` ä½¿ç”¨ç‡ã€å†…å­˜ä½¿ç”¨ç‡æˆ–å…¶ä»–è‡ªå®šä¹‰æŒ‡æ ‡ï¼‰æ¥åŠ¨æ€è°ƒæ•´ `Pod` çš„å‰¯æœ¬æ•°
  - `HPA` ä¹Ÿæ˜¯åŸºäº `ReplicaSet` çš„ï¼Œå¦‚æœå‘ç° `Pod` èµ„æºæŒ‡æ ‡è¿‡å¤§ï¼Œå°±ä¼šåˆ¶ä½œ `Pod` çš„å‰¯æœ¬é™ä½å®¹å™¨æŒ‡æ ‡ï¼Œä¸€æ—¦åˆ©ç”¨ç‡å˜è¿‡ä½å°±ä¼šå›æ”¶å‰¯æœ¬ï¼Œä¹Ÿå°±åšåˆ°äº†æ‰€è°“çš„æ°´å¹³æ‹“å±•
- **==é™æ€æ•°é‡+æ ‡ç­¾ç®¡ç†+æœ‰çŠ¶ç®¡ç†+é¡ºåºä¼¸ç¼© StatefulSet== **
  - ä¸ºäº†è§£å†³ `Docker` è¿™ç§æ— çŠ¶æ€å®¹å™¨çš„ä¸€ç§æ§åˆ¶å™¨ï¼Œä¸Šé¢æåˆ°çš„å››ç§æ§åˆ¶å™¨éƒ½æ˜¯ä¸ºæ— çŠ¶æ€è€Œè®¾è®¡çš„ï¼Œåªæœ‰ `StatefulSet` æ˜¯ä¸ºäº†æœ‰çŠ¶æ€è€Œè®¾è®¡çš„
  - æ¯ä¸ª `Pod` åœ¨ `StatefulSet` ä¸­éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ã€ç¨³å®šçš„ç½‘ç»œæ ‡è¯†ç¬¦ï¼ˆç¨³å®šç½‘ç»œæ ‡è¯†ï¼‰ï¼Œ`Pod` åç§°æ˜¯ç”± `StatefulSet` åç§°å’Œä¸€ä¸ªåºå·ï¼ˆä¾‹å¦‚ `myapp-0`, `myapp-1`ï¼‰ç»„æˆï¼Œè¿™ä½¿å¾—æ¯ä¸ª `Pod` å¯ä»¥é€šè¿‡å…¶ç¨³å®šçš„ `DNS` åç§°è¿›è¡Œè®¿é—®ï¼Œä¸ä¼šå› ä¸º `Pod` è¢«é¡¶æ›¿å°±å‘ç”Ÿæ”¹å˜
  - æ¯ä¸ª `Pod` éƒ½å¯ä»¥ç»‘å®šä¸€ä¸ªæŒä¹…å·ï¼ˆ[å®˜æ–¹æ–‡æ¡£ä¸­æœ‰æåˆ°è¿™ä¸ªæŒä¹…å·](https://kubernetes.io/zh-cn/docs/concepts/storage/persistent-volumes/)ï¼Œè¿™ä¸ªæ¦‚å¿µæˆ‘çŒœæµ‹æ¥æºäºå®¹å™¨ï¼Œå¯ä»¥ç¨³å®šåœ°æŒä¹…åŒ–å­˜å‚¨ï¼‰ï¼Œå³ä½¿åœ¨ `Pod` é‡å¯æˆ–è¿ç§»çš„æƒ…å†µä¸‹ï¼Œæ•°æ®ä¹Ÿèƒ½ä¿æŒä¸€è‡´ã€‚æŒä¹…å·å¯ä»¥ä¸ºæ¯ä¸ª `Pod` æä¾›ç‹¬ç«‹çš„å­˜å‚¨ï¼Œç¡®ä¿åº”ç”¨çš„çŠ¶æ€ä¸ä¼šä¸¢å¤±
  - `StatefulSet` ç¡®ä¿ `Pods` æŒ‰é¡ºåºéƒ¨ç½²å’Œç»ˆæ­¢ï¼ˆæœ‰åºéƒ¨ç½²/æœ‰åºæ‹“å±•ï¼Œæœ‰åºæ”¶ç¼©/æœ‰åºåˆ é™¤ï¼‰ï¼Œåœ¨æ‰©å±•æˆ–ç¼©å‡ `StatefulSet` æ—¶ï¼Œ`Pods` çš„åˆ›å»ºå’Œåˆ é™¤éµå¾ªç‰¹å®šé¡ºåºï¼Œè¿™å¯¹äºéœ€è¦æœ‰åºå¯åŠ¨æˆ–å…³é—­çš„åº”ç”¨ï¼ˆä¾‹å¦‚æ•°æ®åº“ï¼‰éå¸¸é‡è¦
- **==ç‰¹å®šçš„æœåŠ¡ DaemonSet== **
  - `DaemonSet` ç¡®ä¿é›†ç¾¤å†…çš„æ¯ä¸€ä¸ª `Node` å†…éƒ½æœ‰ä¸€ä¸ª `Pod` å‰¯æœ¬
  - å½“é›†ç¾¤åŠ å…¥æ–°çš„ `Node` åï¼Œå°±ä¼šå¢åŠ ä¸€ä¸ª `Pod` å‰¯æœ¬
  - å½“é›†ç¾¤å»é™¤æ—§çš„ `Node` åï¼Œå°±ä¼šå‡å°‘ä¸€ä¸ª `Pod` å‰¯æœ¬
  - æ¯ä¸ªå‰¯æœ¬ `Pod` éƒ½å­˜åœ¨äºä¸åŒçš„ `Node` ä¸­ï¼Œå¹¶ä¸”å„è‡ªåªæœ‰ä¸€ä¸ª
  - è¿™äº›å‰¯æœ¬éƒ½æ˜¯ç›¸åŒåŠŸèƒ½çš„ï¼Œä¸€èˆ¬ä¼šæä¾›åŸºç¡€è®¾ç½®çš„æœåŠ¡ï¼Œä¾‹å¦‚ `å­˜å‚¨daemon`ã€`æ—¥å¿—daemon`ã€`ç›‘æ§daemon` ç­‰ï¼Œè¿™åœ¨æœ‰äº›æ—¶å€™éå¸¸æ–¹ä¾¿
- **==ä¸€æ¬¡æ€§ä»»åŠ¡ Job or Cron Job==**
  - `Job` è´Ÿè´£æ‰¹å¤„ç†ä»»åŠ¡ï¼Œå³åªæ‰§è¡Œä¸€æ¬¡çš„ä»»åŠ¡ï¼Œä¿è¯æ‰¹å¤„ç†ä»»åŠ¡çš„ä¸€ä¸ªæˆ–å¤šä¸ª `Pod` æˆåŠŸç»“æŸ
  - `Cron Job` ç®¡ç†åŸºäºæ—¶é—´çš„ `Job`ï¼Œå³ (1) ç»™å®šæ—¶é—´åªå…è®¸å‘ç”Ÿä¸€æ¬¡ (2)å‘¨æœŸæ€§åœ¨ç»™å®šæ—¶é—´è¿›è¡Œè¿è¡Œ

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ²¡æœ‰ç‰¹æ®Šè¦æ±‚ç›´æ¥ä½¿ç”¨ `Deployment` å³å¯ã€‚


> è¡¥å……ï¼š`Docker` è¢«ç§°ä¸ºâ€œæ— çŠ¶æ€â€çš„ä¸»è¦åŸå› æ˜¯å…¶è®¾è®¡ç†å¿µå’Œå®¹å™¨åŒ–çš„å·¥ä½œæ–¹å¼ã€‚å°½ç®¡æ‚¨å¯ä»¥å°†æ•°æ®æ–‡ä»¶å°è£…è¿› `Docker` é•œåƒä¸­ï¼Œä½†è¿™å¹¶ä¸æ”¹å˜ `Docker` æœ¬èº«çš„æ— çŠ¶æ€ç‰¹æ€§ã€‚
>
> 1. **å®¹å™¨çš„ä¸´æ—¶æ€§** `Docker` å®¹å™¨é€šå¸¸æ˜¯çŸ­æš‚çš„ï¼Œå¯åŠ¨å’Œåœæ­¢ç›¸å¯¹å®¹æ˜“ã€‚å®ƒä»¬è¢«è®¾è®¡ä¸ºåœ¨éœ€è¦æ—¶å¿«é€Ÿå¯åŠ¨ï¼Œè€Œä¸æ˜¯é•¿æœŸè¿è¡Œã€‚å› æ­¤ï¼Œå¦‚æœä¸€ä¸ªå®¹å™¨å´©æºƒæˆ–è¢«åˆ é™¤ï¼Œä»»ä½•æœªæŒä¹…åŒ–çš„æ•°æ®éƒ½å°†ä¸¢å¤±ã€‚
> 2. **æ•°æ®æŒä¹…åŒ–** è™½ç„¶å¯ä»¥å°†æ•°æ®æ–‡ä»¶æ”¾å…¥å®¹å™¨ä¸­ï¼Œä½†å¦‚æœä¸ä½¿ç”¨æ•°æ®å·ï¼Œè¿™äº›æ•°æ®åœ¨å®¹å™¨åˆ é™¤åå°†ä¸¢å¤±ã€‚`Docker` é€šè¿‡å¼•å…¥æ•°æ®å·æ¥å®ç°æŒä¹…åŒ–å­˜å‚¨ï¼Œå…è®¸å®¹å™¨ä¸å®¿ä¸»æœºçš„æ–‡ä»¶ç³»ç»Ÿå…±äº«æ•°æ®ã€‚æ•°æ®å·æä¾›äº†ä¸€ç§æŒä¹…åŒ–çš„æ–¹å¼ï¼Œä½†å®¹å™¨æœ¬èº«ä»ç„¶æ˜¯æ— çŠ¶æ€çš„ã€‚
> 3. **ä¸ä¾èµ–äºå®¹å™¨çš„çŠ¶æ€** åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œæ— çŠ¶æ€æœåŠ¡ä¸ä¾èµ–äºä»»ä½•ç‰¹å®šçš„è¯·æ±‚ä¸Šä¸‹æ–‡æˆ–ä¼šè¯ä¿¡æ¯ã€‚è¿™ä½¿å¾—æœåŠ¡æ›´æ˜“äºæ‰©å±•å’Œç®¡ç†ã€‚æ— çŠ¶æ€è®¾è®¡çš„æœåŠ¡å¯ä»¥åœ¨å¤šä¸ªå®ä¾‹é—´è´Ÿè½½å‡è¡¡ï¼Œä»»æ„å®ä¾‹çš„å´©æºƒæˆ–é‡å¯ä¸ä¼šå½±å“æ•´ä½“æœåŠ¡ã€‚
> 4. **å½±å“é•œåƒçš„å¯é‡ç”¨æ€§** `Docker` é•œåƒæ˜¯ä¸å¯å˜çš„ï¼Œè¿™æ„å‘³ç€æ¯æ¬¡åˆ›å»ºæ–°å®¹å™¨æ—¶éƒ½æ˜¯ä»ç›¸åŒçš„é•œåƒå¼€å§‹ã€‚è¿™ä¸ªç‰¹æ€§ä¿ƒè¿›äº†å®¹å™¨çš„å¯é‡ç”¨æ€§å’Œå¯ç§»æ¤æ€§ï¼Œä½†ä¹Ÿæ„å‘³ç€å®¹å™¨å†…éƒ¨çš„ä»»ä½•çŠ¶æ€æˆ–å˜åŒ–ï¼ˆä¾‹å¦‚æ—¥å¿—æ–‡ä»¶ã€æ•°æ®åº“æ–‡ä»¶ï¼‰éƒ½ä¸ä¼šæŒä¹…ä¿å­˜ã€‚
> 5. **åº”ç”¨çŠ¶æ€ç®¡ç†** å¯¹äºæœ‰çŠ¶æ€åº”ç”¨ï¼Œæ¨èä½¿ç”¨å¤–éƒ¨æ•°æ®åº“æˆ–æŒä¹…åŒ–å­˜å‚¨è§£å†³æ–¹æ¡ˆã€‚è¿™ä¸ `Docker` å®¹å™¨æœ¬èº«çš„çŸ­æš‚æ€§å’Œæ— çŠ¶æ€ç‰¹æ€§ç›¸ä¸€è‡´ã€‚ä½¿ç”¨å¤–éƒ¨å­˜å‚¨ï¼Œå¯ä»¥ç¡®ä¿æ•°æ®åœ¨å®¹å™¨é‡æ–°å¯åŠ¨æˆ–æ›¿æ¢åä»ç„¶å¯ç”¨ã€‚

### 3.3.3.Service

`Service` ä¹Ÿè¢«ç§°ä¸ºâ€œæœåŠ¡å‘ç°â€ï¼Œä¼šæŠŠä¸€ç»„ç›¸å…³çš„ `Pod`ï¼ˆåŒæ ‡ç­¾æˆ–è€…è¯´ç”± `ReplicaSet` æ ‡ç­¾ç®¡ç†çš„ï¼‰æä¾›ä¸€ä¸ªè¢«å¤–ç•Œå‘ç°çš„åŠŸèƒ½ï¼Œå¤–å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡æœåŠ¡å‘ç°ä½¿ç”¨è¿™äº› `Pod`ã€‚

`k8s` ä¸­çš„ `Pod` ä¸€èˆ¬æ˜¯åŠ¨æ€çš„ï¼Œä¼šéšç€è°ƒåº¦ã€æ‰©å®¹ã€ç¼©å®¹ç­‰æ“ä½œè¢«åˆ›å»ºæˆ–é”€æ¯ã€‚å› æ­¤ï¼Œ`Pod` çš„ `IP` åœ°å€ä¹Ÿæ˜¯ä¸´æ—¶çš„ï¼Œå®¢æˆ·ç«¯å¾ˆéš¾ç›´æ¥ä¾èµ– `Pod` çš„ `IP` è¿›è¡Œè®¿é—®ã€‚`Service` é€šè¿‡ä¸ºä¸€ç»„ `Pod` æä¾›ä¸€ä¸ª **ç¨³å®šçš„ IP åœ°å€** å’Œ **åŸŸå**ï¼Œä»è€Œè®©å®¢æˆ·ç«¯ä¸éœ€è¦å…³å¿ƒ `Pod` çš„åŠ¨æ€å˜åŒ–ã€‚

`Service` ä¼šè‡ªåŠ¨å°†è¯·æ±‚åˆ†å‘ç»™å…¶å…³è”çš„å¤šä¸ª `Pod`ï¼Œè¿™ç§è´Ÿè½½å‡è¡¡å¯ä»¥é€šè¿‡ `k8s` çš„ `kube-proxy` å®ç°ã€‚å®¢æˆ·ç«¯å‘ `Service` å‘é€è¯·æ±‚ï¼Œ`Service` ä¼šå°†è¯·æ±‚å‡åŒ€åœ°è½¬å‘ç»™åç«¯çš„å¤šä¸ª `Pod`ã€‚

`k8s` ç½‘ç»œæ¨¡å‹é»˜è®¤æ‰€æœ‰çš„ `Pod` å†…çš„å®¹å™¨éƒ½åœ¨ä¸€ä¸ªå¯ä»¥ç›´æ¥è¿é€šçš„æ‰å¹³åŒ–ç½‘ç»œä¸­ï¼ˆå…¶å®å°±æ˜¯ä¸€ä¸ªå±€åŸŸç½‘ä¸­ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬åç»­éœ€è¦ä¿è¯è¿™ä¸ªç½‘ç»œå‡è®¾æˆç«‹ã€‚

>   è¡¥å……ï¼šä¸Šé¢ `Pod` è¿™ç§ç®¡ç†ä¹Ÿè¢«ç§°ä¸ºâ€œæ‰å¹³åŒ–ç®¡ç†â€ï¼Œåœ¨å…¬å¸ä¸­çš„â€œæ‰å¹³åŒ–ç®¡ç†â€æ˜¯ä¸€ç§ç»„ç»‡ç®¡ç†ç»“æ„ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯å‡å°‘ç®¡ç†å±‚çº§ï¼Œå¼ºè°ƒè¾ƒå°‘çš„ç®¡ç†å±‚æ¬¡å’Œæ›´å¤§çš„å‘˜å·¥è‡ªä¸»æƒï¼ˆä¹Ÿæ˜¯æœ‰çš„å…¬å¸è§„æ¨¡è¾ƒå°çš„ä¸€ç§å§”å©‰è¯´è¾...ï¼‰ã€‚

è¿™é‡Œæˆ‘ä»¬æ€ä¹ˆä¿è¯å¤šä¸ª `Pod` åœ¨é›†ç¾¤æéƒ½åœ¨ä¸€ä¸ªæ‰å¹³åŒ–ç½‘ç»œä¸­å‘¢ï¼Ÿé¦–å…ˆæ‚¨è¦æ˜ç™½å¤šä¸ª `Pod` ä¸ä¸€å®šåªåœ¨ä¸€ä¸ªç‰©ç†ä¸»æœºä¸Šï¼Œå°½ç®¡å¯ä»¥ä¿è¯ç‰©ç†ä¸»æœºä»¬å¤„äºåŒä¸€ä¸ªå±€åŸŸç½‘ä¸­ï¼Œä½†æ˜¯ç”±äºä¸€ä¸ªé›†ç¾¤çš„ä¸åŒ `Pod` å¯èƒ½å­˜æ”¾åœ¨ä¸åŒçš„ç‰©ç†ä¸»æœºä¸Šï¼Œè€Œ `Pod` åˆéœ€è¦ä¿æŒåœ¨ä¸€ä¸ªå±€åŸŸç½‘ä¸­ï¼Œè¿™è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿæˆ‘ä»¬å…ˆæ¥ç ”ç©¶ä¸åŒä¸»ä½“é—´çš„é€šä¿¡ã€‚

![image-20241013150452662](./assets/image-20241013150452662.png)

-   **Pod å†…çš„å¤šä¸ªå®¹å™¨é€šä¿¡**ï¼šå¤šä¸ª `Pod` åœ¨ä¸€ä¸ªæœ¬åœ°ç½‘ä¸­é€šä¿¡ï¼ˆå…¶å®å…±äº«çš„æ˜¯ `Pause` å®¹å™¨çš„ç½‘ç»œæ ˆï¼Œä¹Ÿå°±æ˜¯ `Pause` å®¹å™¨çš„ `lo`ï¼Œè¿™å…¶å®è¿˜æ˜¯åœ¨å®¹å™¨å†…éƒ¨åšæœ¬åœ°é€šä¿¡ï¼Œè¿™ä¸ªç®€å•ï¼‰
-   **Pod å’Œ Pod é—´é€šä¿¡**ï¼š`Pod` å†…å¤šä¸ªå®¹å™¨åœ¨ä¸€ä¸ªå±€åŸŸç½‘ä¸­é€šä¿¡ï¼Œå¹¶ä¸”ä¿è¯æºå¤´å’Œç›®çš„éƒ½æ˜¯ `Pod` çš„ `IP` åœ°å€ï¼ˆå¦‚æœæ˜¯ä¸€ä¸ªç‰©ç†ä¸»æœºä¸Šçš„ï¼Œç›´æ¥é€šè¿‡ `Docker` å®ç°çš„è™šæ‹Ÿç½‘å¡ `docker0` å³å¯å®Œæˆä¸åŒ `Pod` çš„é€šä¿¡ï¼›ä½†æ˜¯å¦‚æœæ˜¯ä¸åŒä¸»æœºä¸Šçš„ `Pod` å°±éœ€è¦è¿›ä¸€æ­¥é€šè¿‡è™šæ‹Ÿç½‘å¡ `Flannel0` æ¥å®ç°ï¼Œè¿™é€šå¸¸éœ€è¦ç‰©ç†ä¸»æœºå®‰è£…ä¸€ä¸ª `Flanneld` çš„å®ˆæŠ¤è¿›ç¨‹ï¼Œ`Flannel0` è´Ÿè´£æŠ“åŒ…ã€å°è£…ã€è½¬å‘ `docker0` çš„è¯·æ±‚ï¼Œç„¶åé€šè¿‡ `etcd` è·å–å¾—åˆ°è·¯ç”±è¡¨åˆ¤æ–­åˆ°åº•è¯¥ä½¿ç”¨ `Flanneld` è½¬å‘åˆ°ç‰©ç†å±€åŸŸç½‘ä¸­çš„å“ªä¸€ä¸ªæœºå™¨ä¸Šï¼Œç”±ä¸åŒç‰©ç†æœºä¸Šéƒ¨ç½²çš„ `Flanneld` æ¥å¤„ç†ï¼Œè€Œè¿™å°±æ˜¯ `Overlay Network` çš„åŸç†ï¼‰
-   **Pod å‘ Service é—´é€šä¿¡**ï¼šé€šè¿‡å„ä¸ªèŠ‚ç‚¹çš„ `Iptables` è§„åˆ™æ¥åšåˆ°ï¼ˆä¸è¿‡è¿™æ˜¯æ¯”è¾ƒè€çš„æ¨¡å¼ï¼Œæ–°ç‰ˆæœ¬çš„ `k8s` è¿˜æœ‰å…¶ä»–ç°ä»£æ–¹æ¡ˆï¼‰
-   **å¤–ç½‘è®¿é—® Pod**ï¼šä¾é æœåŠ¡å‘ç° `Service` æ¥åšåˆ°è®¿é—® `pod` æ‰å¹³ç½‘ç»œ

>   è¡¥å……ï¼š`Flannel` ä½¿ç”¨çš„æ˜¯ `UDP` æ¥è½¬å‘æŠ¥æ–‡ï¼Œåœ¨ `Flannerl` å†…éƒ¨æœ‰ä¸€ä¸ªå°è£…æ ˆï¼Œå¯ä»¥å°è£… `UDP` æŠ¥æ–‡ã€`æºå¤´ Pod IP`ã€`ç›®çš„ Pod IP` ç­‰ä¿¡æ¯ä¸ºä¸€ä¸ªæ–°çš„æŠ¥æ–‡è½¬å‘å‡ºå»ï¼Œæœ‰å¤šä¸ªç‰©ç†ä¸»æœºä¸­éƒ¨ç½²çš„ `Flanneld` æ¥è´Ÿè´£ç›¸äº’ä¼ é€’å’Œè§£åŒ…å¤„ç†ã€‚å½“ç„¶è¿™å…¶ä¸­çš„æ¶ˆè€—çœ‹ä¸Šå»è¿˜æ˜¯æœ‰çš„ï¼Œå¹¶ä¸”æ„Ÿè§‰ä¸å°‘...
>
>   `etcd` åœ¨è¿™é‡Œå‘æŒ¥äº†å¾ˆå¤§çš„ä½œç”¨ï¼Œå®ƒå¿…é¡»èƒ½å¤Ÿåšåˆ°å­˜å‚¨ç®¡ç† `Flannel` å¯ä»¥åˆ†é…çš„ `IP` åœ°å€èµ„æºï¼Œç›‘æ§æ¯ä¸€ä¸ª `Pod` çš„åœ°å€ï¼Œå¹¶åœ¨å†…å­˜ä¸­å»ºç«‹ç»´æŠ¤é›†ç¾¤æ‰€æœ‰çš„ `Pod` èŠ‚ç‚¹è·¯ç”±ã€‚
>
>   ![image-20241013155819811](./assets/image-20241013155819811.png)

>   è¡¥å……ï¼šå› æ­¤åœ¨ `k8s` ä¸­æœ‰ä¸‰ç§ä¸åŒå±‚æ¬¡çš„ç½‘ç»œï¼Œ`Node ç½‘ç»œ`ã€`Pod ç½‘ç»œ`ã€`Service ç½‘ç»œ`ï¼Œå…¶ä¸­çœŸå®çš„ç½‘ç»œåªæœ‰ `Node ç½‘ç»œ`ï¼Œä¹Ÿå°±æ˜¯å®¿ä¸»ä¸»æœºä»¬ä¹‹é—´çš„å±€åŸŸç½‘ç½‘ç»œã€‚
>
>   è¿™æ ·é›†ç¾¤å†…çš„å¼€å‘åªéœ€è¦ä½¿ç”¨ `Pod ç½‘ç»œ`ï¼Œè€Œæ•´ä¸ªé›†ç¾¤å¯¹åº”çš„å…¬å¸æœåŠ¡åˆ™éœ€è¦ä½¿ç”¨ `Service` ç½‘ç»œè¿›è¡Œå¯¹å¤–å‘å¸ƒã€‚

## 3.4.k8s çš„åŸºæœ¬æ“ä½œ

åŸºæœ¬çš„ç†è®ºçŸ¥è¯†æˆ‘ä»¬æœ‰äº†ï¼Œè¿™é‡Œæˆ‘ä»¬ç®€å•æ¼”ç¤ºä¸€ä¸‹å…³äº `k8s` çš„å‘½ä»¤è¡Œå·¥å…·æ¥æ„å»ºä¸€ä¸ªå¯ç”¨çš„ `k8s` é›†ç¾¤ã€‚å®é™…ä¸Šæˆ‘ä¸æ¨èæ‚¨ç›´æ¥ä½¿ç”¨ `k8s` çš„åŸç”Ÿå‘½ä»¤è¡Œå·¥å…·æ¥æ“ä½œé›†ç¾¤ï¼Œè¿™ä¸ªå­¦ä¹ æ›²çº¿å¯èƒ½è®©æ‚¨æ„Ÿåˆ°æ²®ä¸§...ä¸è¿‡ä¸‡å¹¸çš„æ˜¯ï¼Œæˆ‘ä»¬æœ‰é€‚åˆå•æœºæµ‹è¯•å­¦ä¹ ä½¿ç”¨çš„ã€å°è£…åœ¨åŸç”Ÿå‘½ä»¤è¡Œå·¥å…·ä¸Šå±‚çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œè¿™ä¸ªå·¥å…·å°±æ˜¯ `Minikube`ã€‚

### 3.4.1.Minikube é›†ç¾¤çš„åˆ›å»º

```shell
# ä½¿ç”¨ minilube åˆå§‹åŒ–é›†ç¾¤
# ç»™å½“å‰ç”¨æˆ·è®¾ç½®å¯åŠ¨ docker ä¸éœ€è¦ä½¿ç”¨ sudo
$ sudo usermod -aG docker $USER # å°†å½“å‰ç”¨æˆ·æ·»åŠ åˆ° docker ç»„ä¸­
$ newgrp docker # ç«‹å³æ›´æ–°å½“å‰ shell ä¼šè¯ä¸­çš„ç”¨æˆ·ç»„, ä½¿å¾—æ–°åŠ å…¥çš„ docker ç»„ç”Ÿæ•ˆ

# åˆ›å»º Minikube é›†ç¾¤
$ minikube start
# å®é™…ä¸Š minikube start è¿™ä¸ªæŒ‡ä»¤æ‹‰å–äº†é•œåƒæ–‡ä»¶(é»˜è®¤ä½¿ç”¨ Docker å·¥å…·æ‹‰å–)
# å¯ä»¥ä½¿ç”¨ sudo docker image æ¥æŸ¥çœ‹æ‹‰å–çš„é•œåƒæ–‡ä»¶å¦‚ä¸‹
# gcr.io/k8s-minikube/kicbase   v0.0.45   aeed0e1d4642   4 weeks ago   1.28GB
# gcr.io/k8s-minikube/kicbas è¿™ä¸ªåŸºç¡€é•œåƒå†…éƒ¨åŒ…å«äº†è¿è¡Œ k8s çš„åŸºç¡€å·¥å…·), é€‚ç”¨äº Minikube çš„ KIC åŠŸèƒ½(Kubernetes In Docker, ä¸€ä¸ªåœ¨ Docker å®¹å™¨ä¸­è¿è¡Œ Kubernetes çš„æ–¹æ³•), minikube start è¿˜ä¼šå¯åŠ¨è¿™ä¸ªé•œåƒä¸ºå®¹å™¨, æ–¹ä¾¿å¼€å‘è€…è¿›è¡Œé›†ç¾¤éƒ¨ç½², æ‚¨å¯ä»¥ä½¿ç”¨ sudo docker container ls è¿›è¡ŒæŸ¥çœ‹

# minikube stop # åœæ­¢é›†ç¾¤
# minikube delete # åˆ é™¤é›†ç¾¤

```

>   æ³¨æ„ï¼šå¼ºçƒˆæ¨èåœ¨å­¦ä¹ é˜¶æ®µé…ç½® `alias kubectl="minikube kubectl --"` æé«˜ç»ˆç«¯ä½“éªŒï¼Œ`Minikube` è‡ªå¸¦ä¸€ä¸ª `kubectl` å®¢æˆ·ç«¯, å’Œ `Minikube` å…¼å®¹æ€§è¾ƒå¥½ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªæœ€ä½³å®è·µã€‚

### 3.4.2.Minikube é›†ç¾¤çš„åŸç†

å®é™…ä¸Šåœ¨ `minilube` ä¸­ä½¿ç”¨çš„ `k8s` æ˜¯è£…è½½è¿›ä¸€ä¸ªå®¹å™¨ä¸­è¿è¡Œçš„ï¼Œè€Œå®¹å™¨å†…éƒ¨åˆä¸‹è½½äº†é•œåƒæ–‡ä»¶ï¼Œè¿è¡Œäº†å¤šä¸ªå­å®¹å™¨ï¼ˆè¿™ç§ç°è±¡å°±æ˜¯ `KIC`ï¼‰ã€‚å› æ­¤ï¼Œå¦‚æœç¯å¢ƒä¸æ”¯æŒåµŒå¥—è™šæ‹ŸåŒ–ï¼Œæ˜¯æ²¡åŠæ³•è¿è¡Œ `minilube` å·¥å…·çš„ã€‚

ç®€å•æ¥è¯´ `minikube` é€šè¿‡å†…éƒ¨çš„å¤šä¸ª `Pos` å®¹å™¨æ¨¡æ‹Ÿ `k8s` éƒ¨ç½²ä¸­ç‰©ç† `Node`ï¼Œè¿™äº›è™šæ‹Ÿ `Node` æ˜¯ `k8s` è¿è¡Œå¿…é¡»çš„ç»„ä»¶ï¼ŒåŸæœ¬åº”è¯¥è¿è¡Œåœ¨ç‰©ç†ä¸»æœºä¸­çš„ï¼Œè€Œä¸åº”è¯¥ä¸€èµ·è¢«æ”¾åœ¨æœ¬ `Node` ä¸­å’Œå…¶ä»– `pod` å¡åœ¨ä¸€èµ·ã€‚

### 3.4.3.minilube é›†ç¾¤çš„æŸ¥çœ‹

```shell
# æŸ¥çœ‹é›†ç¾¤
# æ˜¾ç¤º k8s é›†ç¾¤çš„åŸºæœ¬ä¿¡æ¯
$ kubectl cluster-info
Kubernetes control plane is running at https://192.168.49.2:8443 # è¿™è¡Œè¡¨ç¤º Kubernetes æ§åˆ¶å¹³é¢æ­£åœ¨è¿è¡Œï¼Œå¹¶ä¸”æš´éœ²åœ¨ https://192.168.49.2:8443 åœ°å€ä¸Š
CoreDNS is running at https://192.168.49.2:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy # è¿™è¡Œè¡¨ç¤º Kubernetes ä¸­çš„ DNS æœåŠ¡ CoreDNS æ­£åœ¨è¿è¡Œ, å¹¶ä¸”å®ƒå¯ä»¥é€šè¿‡åœ°å€ CoreDNS is running at https://192.168.49.2:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy è®¿é—®

# å…¶ä¸­: æ§åˆ¶å¹³é¢æ˜¯ Kubernetes é›†ç¾¤çš„æ ¸å¿ƒ, è´Ÿè´£å…¨å±€ç®¡ç†å’Œè°ƒåº¦ä»»åŠ¡, å®ƒå†³å®šé›†ç¾¤çš„çŠ¶æ€, å¹¶ç¡®ä¿é›†ç¾¤åœ¨æœŸæœ›çš„çŠ¶æ€ä¸‹è¿è¡Œã€‚æ§åˆ¶å¹³é¢ç”±å¤šä¸ªç»„ä»¶æ„æˆ, ä¸»è¦åŒ…æ‹¬:
# kube-apiserver, etcd, kube-scheduler, kube-controller-manager, cloud-controller-manager

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.

# æ˜¾ç¤º k8s é›†ç¾¤çš„æ‰€æœ‰ Node
$ kubectl get nodes
NAME       STATUS   ROLES           AGE   VERSION
minikube   Ready    control-plane   29d   v1.31.0

# æ˜¾ç¤º k8s é›†ç¾¤çš„æ‰€æœ‰ Pod
$ kubectl get pods --all-namespaces # æŸ¥çœ‹æ‰€æœ‰çš„ pod, pod é€šå¸¸ä»£è¡¨ k8s ä¸­çš„ä¸€ä¸ªæœ€å°è°ƒåº¦å•ä½(å¯ä»¥ç”±ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ç»„æˆ), å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªé€»è¾‘ä¸»æœº, æ‹¥æœ‰å”¯ä¸€çš„ ip åœ°å€, å…±äº«ç½‘ç»œç«¯å£èµ„æº, å…±äº«å­˜å‚¨å·èµ„æº, ç®€åŒ–æŒ‡ä»¤ä¸º kubectl get pod -A
NAMESPACE     NAME                               READY   STATUS    RESTARTS      AGE
# coredns æ˜¯ k8s é»˜è®¤çš„ DNS æœåŠ¡, è´Ÿè´£é›†ç¾¤å†…éƒ¨çš„ DNS è§£æ
kube-system   coredns-6f6b679f8f-lsczv           1/1     Running   0             76m
# etcd-minikube å°±æ˜¯ä¸Šé¢æˆ‘ä»¬æåˆ°çš„åˆ†å¸ƒå¼é”®å€¼å­˜å‚¨ç³»ç»Ÿ etcd
kube-system   etcd-minikube                      1/1     Running   0             76m
# kube-apiserver-minikube å°±æ˜¯ä¸Šé¢æˆ‘ä»¬æåˆ°çš„ç¹å¿™çš„ api server
kube-system   kube-apiserver-minikube            1/1     Running   0             76m
# kube-controller-manager-minikube å°±æ˜¯ä¸Šé¢æˆ‘ä»¬æåˆ°çš„ç®¡ç† pod ç”Ÿå‘½å‘¨æœŸçš„æ§åˆ¶å™¨ controller
kube-system   kube-controller-manager-minikube   1/1     Running   0             76m
# kube-proxy-82hjt å°±æ˜¯ä¸Šé¢æˆ‘ä»¬æåˆ°çš„ç”¨æ¥ç½‘ç»œè´Ÿè½½å‡è¡¡çš„ç½‘ç»œä»£ç†
kube-system   kube-proxy-82hjt                   1/1     Running   0             76m
# kube-scheduler-minikube å°±æ˜¯ä¸Šé¢æˆ‘ä»¬æåˆ°ç”¨æ¥æäº¤ä»»åŠ¡åˆ†é…çš„è°ƒåº¦å™¨
kube-system   kube-scheduler-minikube            1/1     Running   0             76m
# storage-provisioner è‡ªåŠ¨åŒ–å­˜å‚¨å·, ä»¥åå†æ¥ç†è§£
kube-system   storage-provisioner                1/1     Running   2 (76m ago)   76m
# è¿™äº› pod å…¶å®å°±æ˜¯ gcr.io/k8s-minikube/kicbase é•œåƒè¿è¡Œä¸ºå®¹å™¨åä¸­çš„å­å®¹å™¨, è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘è¯´ Minikube é€‚åˆå­¦ä¹ è€Œä¸é€‚åˆç”Ÿäº§ç¯å¢ƒçš„åŸå› , è¿™äº› pod éƒ½åœ¨æ¨¡æ‹Ÿä¸€ä¸ªç‰©ç†ä¸»æœº(å…¶å®å°±æ˜¯è™šæ‹Ÿä¸»æœº), å¹¶ä¸”é»˜è®¤æ¯ä¸ª pod å†…éƒ¨éƒ½åªæœ‰ä¸€ä¸ªå®¹å™¨

# å› æ­¤ä¸Šè¿°çš„ Pod éƒ½æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„ Node

# æŸ¥çœ‹ä¸€ä¸ª pod å†…éƒ¨çš„å®¹å™¨
$ kubectl \
describe \ # è¦æŸ¥çœ‹èµ„æºçš„è¯¦ç»†ä¿¡æ¯
pod \ # è¦æŸ¥çœ‹èµ„æºçš„ç±»å‹
etcd-minikube \ # è¦æŸ¥çœ‹çš„èµ„æºçš„åç§°
-n kube-system # è¦æŸ¥çœ‹çš„èµ„æºçš„å‘½åç©ºé—´
Name:                 etcd-minikube
Namespace:            kube-system
Priority:             2000001000
Priority Class Name:  system-node-critical
Node:                 minikube/192.168.49.2
Start Time:           Tue, 05 Nov 2024 19:42:28 +0800
Labels:               component=etcd
                      tier=control-plane
Annotations:          kubeadm.kubernetes.io/etcd.advertise-client-urls: https://192.168.49.2:2379
                      kubernetes.io/config.hash: a5363f4f31e043bdae3c93aca4991903
                      kubernetes.io/config.mirror: a5363f4f31e043bdae3c93aca4991903
                      kubernetes.io/config.seen: 2024-10-08T05:05:17.090614707Z
                      kubernetes.io/config.source: file
Status:               Running
SeccompProfile:       RuntimeDefault
IP:                   192.168.49.2
IPs:
  IP:           192.168.49.2
Controlled By:  Node/minikube
Containers:
  etcd:
    Container ID:  docker://1ccd78f1ddf251539643cb7d03ff23a9362a262ae99e10700d11fedb2c2a6d9c
    Image:         registry.k8s.io/etcd:3.5.15-0
    Image ID:      docker-pullable://registry.k8s.io/etcd@sha256:a6dc63e6e8cfa0307d7851762fa6b629afb18f28d8aa3fab5a6e91b4af60026a
    Port:          <none>
    Host Port:     <none>
    Command:
      etcd
      --advertise-client-urls=https://192.168.49.2:2379
      --cert-file=/var/lib/minikube/certs/etcd/server.crt
      --client-cert-auth=true
      --data-dir=/var/lib/minikube/etcd
      --experimental-initial-corrupt-check=true
      --experimental-watch-progress-notify-interval=5s
      --initial-advertise-peer-urls=https://192.168.49.2:2380
      --initial-cluster=minikube=https://192.168.49.2:2380
      --key-file=/var/lib/minikube/certs/etcd/server.key
      --listen-client-urls=https://127.0.0.1:2379,https://192.168.49.2:2379
      --listen-metrics-urls=http://127.0.0.1:2381
      --listen-peer-urls=https://192.168.49.2:2380
      --name=minikube
      --peer-cert-file=/var/lib/minikube/certs/etcd/peer.crt
      --peer-client-cert-auth=true
      --peer-key-file=/var/lib/minikube/certs/etcd/peer.key
      --peer-trusted-ca-file=/var/lib/minikube/certs/etcd/ca.crt
      --proxy-refresh-interval=70000
      --snapshot-count=10000
      --trusted-ca-file=/var/lib/minikube/certs/etcd/ca.crt
    State:          Running
      Started:      Tue, 05 Nov 2024 19:42:28 +0800
    Last State:     Terminated
      Reason:       Completed
      Exit Code:    0
      Started:      Tue, 08 Oct 2024 18:40:19 +0800
      Finished:     Sun, 13 Oct 2024 10:35:49 +0800
    Ready:          True
    Restart Count:  12
    Requests:
      cpu:        100m
      memory:     100Mi
    Liveness:     http-get http://127.0.0.1:2381/livez delay=10s timeout=15s period=10s #success=1 #failure=8
    Readiness:    http-get http://127.0.0.1:2381/readyz delay=0s timeout=15s period=1s #success=1 #failure=3
    Startup:      http-get http://127.0.0.1:2381/readyz delay=10s timeout=15s period=10s #success=1 #failure=24
    Environment:  <none>
    Mounts:
      /var/lib/minikube/certs/etcd from etcd-certs (rw)
      /var/lib/minikube/etcd from etcd-data (rw)
Conditions:
  Type                        Status
  PodReadyToStartContainers   True 
  Initialized                 True 
  Ready                       True 
  ContainersReady             True 
  PodScheduled                True 
Volumes:
  etcd-certs:
    Type:          HostPath (bare host directory volume)
    Path:          /var/lib/minikube/certs/etcd
    HostPathType:  DirectoryOrCreate
  etcd-data:
    Type:          HostPath (bare host directory volume)
    Path:          /var/lib/minikube/etcd
    HostPathType:  DirectoryOrCreate
QoS Class:         Burstable
Node-Selectors:    <none>
Tolerations:       :NoExecute op=Exists
Events:            <none>

```

ä»ä¸Šé¢çš„è¾“å‡ºå¯ä»¥çœ‹å‡ºï¼Œæˆ‘çš„ `pod` å†…éƒ¨åªæœ‰ä¸€ä¸ªå®¹å™¨ï¼Œæœ¬æ•™ç¨‹å…³äº `minikube` çš„ä½¿ç”¨å…¨éƒ½é‡‡ç”¨ `pod` å†…å•ä¸ªå®¹å™¨çš„åšæ³•ï¼Œæ‹“å±•å®¹å™¨æˆ‘ä»¬åé¢å†æ¥è®¨è®ºã€‚

### 3.4.4.minikube é›†ç¾¤çš„å¯åœ

```shell
# å¯åœå®¹å™¨
$ minikube pause # æš‚åœé›†ç¾¤
$ minikube unpause # å¯åŠ¨é›†ç¾¤
$ minikube stop # åœæ­¢é›†ç¾¤(å°±ç›¸å½“äºå…³é—­å®¹å™¨çš„è¿è¡Œ)
# ä½¿ç”¨ minikube delete åˆ™å¯ä»¥é”€æ¯é›†ç¾¤
```

### 3.4.5.minikube é¢å¤–çš„æ’ä»¶

```shell
# ä½¿ç”¨æ’ä»¶
$ minikube addons list # æµè§ˆæ’ä»¶
$ minikube addons enable dashboard # æ‰“å¼€å…¶ä¸­ä¸€ä¸ªæ’ä»¶
$ minikube dashboard # å¯åŠ¨æ’ä»¶
# è¿™å°†åœ¨æœ¬åœ°éƒ¨ç½²ä¸€ä¸ªé¢æ¿ç½‘ç«™, åœ¨æµè§ˆå™¨ä¸­è®¿é—®è¿”å›çš„åœ°å€å³å¯æ‰“å¼€è¯¥é¢æ¿

```

![260f61c222ca5e1d800fc11204f88e43](./assets/260f61c222ca5e1d800fc11204f88e43-1728388537284-7.png)

>   è¡¥å……ï¼šè§£å†³ä»£ç†é—®é¢˜ï¼Œæˆ‘è¿™é‡Œåˆšå¥½æœ‰ä¸‰ä¸ªé•œåƒæ˜¯æ‹‰å–å¤±è´¥çš„ã€‚
>
>   ```shell
>   # è§£å†³è¿œç«¯é•œåƒé—®é¢˜
>   # æ£€æŸ¥é›†ç¾¤å®¹å™¨æ˜¯å¦å·²ç»å¯åŠ¨
>   $ docker container ls
>   CONTAINER ID   IMAGE                                 COMMAND                   CREATED       STATUS          PORTS                                                                                                                                  NAMES
>   1725c0030203   gcr.io/k8s-minikube/kicbase:v0.0.45   "/usr/local/bin/entrâ€¦"   4 weeks ago   Up 49 seconds   127.0.0.1:32768->22/tcp, 127.0.0.1:32769->2376/tcp, 127.0.0.1:32770->5000/tcp, 127.0.0.1:32771->8443/tcp, 127.0.0.1:32772->32443/tcp   minikube
>   
>   # è¿›å…¥ minikube ssh ç»ˆç«¯, ä¹Ÿå°±æ˜¯ minikube å®¹å™¨çš„å†…éƒ¨
>   $ minikube ssh # ç›¸å½“äºä½¿ç”¨ exec æŒ‡ä»¤
>   
>   # å¦‚æœä½¿ç”¨ docker image ls å°±å¯ä»¥çœ‹åˆ°æœ‰ä¸‰ä¸ªé•œåƒæ²¡æœ‰è¢«æ‹‰å–ä¸‹æ¥, ä¸‹é¢æŒ‰ç…§æ‚¨ç¼ºå¤±çš„é•œåƒæ–‡ä»¶, ä¾è‘«èŠ¦ç”»ç“¢ä»ä¸€äº›å›½å†…é•œåƒæºä¸­è·å–å³å¯...
>   
>   # åœ¨ä¸€äº›å›½å†…å­˜å‚¨åº“ä¸­(ä¾‹å¦‚é˜¿é‡Œäº‘)æ‹‰å–é•œåƒæ–‡ä»¶
>   # æ‹‰å– metrics-server
>   $ docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server:v0.7.2
>   $ docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server:v0.7.2 kubernetes/metrics-server:v0.7.2
>   
>   # æ‹‰å– metrics-scraper
>   $ docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-scraper:v1.0.8
>   $ docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-scraper:v1.0.8 kubernetesui/metrics-scraper:v1.0.8
>   
>   # æ‹‰å– dashboard
>   $ docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/dashboard:v2.7.0
>   $ docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/dashboard:v2.7.0 kubernetesui/dashboard:v2.7.0
>   
>   # ä¿®æ”¹é•œåƒæ‹‰å–ç­–ç•¥, æ”¹é…ç½®æ–‡ä»¶ä¸­, ä¼˜å…ˆä½¿ç”¨æœ¬åœ°é•œåƒè€Œä¸æ˜¯æ‹‰å–è¿œç«¯é•œåƒ
>   $ kubectl edit deployment kubernetes-dashboard -n kubernetes-dashboard
>   $ kubectl edit deployment dashboard-metrics-scraper -n kubernetes-dashboard
>   $ kubectl edit deployment metrics-server -n kube-system
>   
>   # å¦‚ä¸‹å›¾çº¢æ¡†å¤„è¿›è¡Œä¿®æ”¹...
>   
>   ```
>
>   ![image-20241008194935021](./assets/image-20241008194935021.png)
>
>   ```shell
>   # é€€å‡º minikube ssh æ£€æŸ¥æ­¤æ—¶æ‰€æœ‰çš„ pod çš„çŠ¶æ€æ˜¯å¦éƒ½ä¸º runing
>   $ exit
>   
>   $ kubectl get pod -A
>   NAMESPACE              NAME                                        READY   STATUS    RESTARTS       AGE
>   kube-system            coredns-6f6b679f8f-lsczv                    1/1     Running   11 (62m ago)   6h36m
>   kube-system            coredns-6f6b679f8f-x62pf                    1/1     Running   11 (62m ago)   6h36m
>   kube-system            etcd-minikube                               1/1     Running   11 (63m ago)   6h36m
>   kube-system            kube-apiserver-minikube                     1/1     Running   11 (62m ago)   6h36m
>   kube-system            kube-controller-manager-minikube            1/1     Running   12 (63m ago)   6h36m
>   kube-system            kube-proxy-82hjt                            1/1     Running   11 (63m ago)   6h36m
>   kube-system            kube-scheduler-minikube                     1/1     Running   11 (63m ago)   6h36m
>   kube-system            metrics-server-667d84658b-k82fh             1/1     Running   0              98s
>   kube-system            storage-provisioner                         1/1     Running   20 (61m ago)   6h36m
>   kubernetes-dashboard   dashboard-metrics-scraper-6fb8867c9-cw57k   1/1     Running   0              8m17s
>   kubernetes-dashboard   kubernetes-dashboard-6b7bbd4ddc-tx7vt       1/1     Running   0              30m
>   
>   $ minikube dashboard # éå¸¸å®Œç¾è¿è¡Œèµ·æ¥...
>   ğŸ¤”  æ­£åœ¨éªŒè¯ dashboard è¿è¡Œæƒ…å†µ ...
>   ğŸš€  æ­£åœ¨å¯åŠ¨ä»£ç†...
>   ğŸ¤”  æ­£åœ¨éªŒè¯ proxy è¿è¡ŒçŠ¶å†µ ...
>   ğŸ‰  æ­£åœ¨ä½¿ç”¨é»˜è®¤æµè§ˆå™¨æ‰“å¼€ http://127.0.0.1:33045/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/ ...
>   Failed to open display
>   Warning: failed to launch javaldx - java may not function correctly
>   
>   ```
>
>   å…¶ä»–æƒ…å†µä¸‹ä¹Ÿéƒ½å¯ä»¥è¿™ä¹ˆè¿›è¡Œé…ç½®...

### 3.4.6.minikube çš„èµ„æºæ§åˆ¶

æˆ‘ä»¬æœ¬èŠ‚çš„ `minikube` åˆ›å»ºäº†ä¸€ä¸ª `MiniNode`ï¼Œæ˜¯ç›¸å¯¹äºæœ¬æœºï¼ˆç‰©ç† `Node`ï¼‰çš„è™šæ‹Ÿ `Node`ï¼Œè€Œè¿™ä¸ªè™šæ‹Ÿ `Node` å†…éƒ¨å…è®¸äº†å¤šä¸ª `Pod`ã€‚æ¯ä¸ª `Pod` å†…éƒ¨åªæœ‰ä¸€ä¸ªå®¹å™¨ï¼Œæ¯ä¸ª `pod` æ¨¡æ‹Ÿäº†çœŸå®çš„ `Node`ï¼ˆè™šä¸ŠåŠ è™šçš„ `Node`ï¼‰ï¼Œè¿è¡Œäº† `k8s` çš„å¿…å¤‡ç»„ä»¶ã€‚

```shell
# åˆ›å»ºæ§åˆ¶å™¨æ¥ç®¡ç† Node
$ kubectl \
create deployment hello-node \ # åˆ›å»ºå®¹å™¨ç”Ÿå‘½å‘¨æœŸæ§åˆ¶å™¨, æ§åˆ¶å™¨çš„åå­—
--image=registry.k8s.io/e2e-test-images/agnhost:2.39 \ # æµ‹è¯•é•œåƒæ–‡ä»¶
-- /agnhost netexec --http-port=8080 # å®¹å™¨è¢«åˆ›å»ºå‡ºæ¥åæ‰§è¡Œçš„æŒ‡ä»¤
# åˆèµ·æ¥å°±æ˜¯ kubectl create deployment hello-node --image=registry.k8s.io/e2e-test-images/agnhost:2.39 -- /agnhost netexec --http-port=8080

$ kubectl get pods --all-namespaces
NAMESPACE     NAME                               READY   STATUS              RESTARTS      AGE
default       hello-node-66d457cb86-5xc7b        0/1     ContainerCreating   0             6s
kube-system   coredns-6f6b679f8f-ksglg           1/1     Running             0             42m
kube-system   etcd-minikube                      1/1     Running             0             42m
kube-system   kube-apiserver-minikube            1/1     Running             0             42m
kube-system   kube-controller-manager-minikube   1/1     Running             0             42m
kube-system   kube-proxy-wnr99                   1/1     Running             0             42m
kube-system   kube-scheduler-minikube            1/1     Running             0             42m
kube-system   storage-provisioner                1/1     Running             2 (42m ago)   42m

# è·å–é™¤äº† k8s ç»„ä»¶ä»¥å¤–çš„ Pod
$ kubectl get pods
NAME                          READY   STATUS              RESTARTS   AGE
hello-node-66d457cb86-5xc7b   0/1     ContainerCreating   0          31s

# æŸ¥çœ‹æ§åˆ¶å™¨
$ kubectl get deployments
NAME         READY   UP-TO-DATE   AVAILABLE   AGE
hello-node   0/1     1            0           14m

```

ä¸Šè¿°æŒ‡ä»¤åˆ›å»ºäº†ä¸€ä¸ªæ§åˆ¶å™¨ `hello-node`ï¼Œè¿™ä¸ªæ§åˆ¶å™¨ç”¨æ¥ç®¡ç† `agnhost` é•œåƒè¿è¡Œèµ·æ¥å®¹å™¨çš„ `Pod`ï¼Œè¿™ä¸ª `Pod` è¿˜æ˜¯äº¤ç»™ `MiniNode` ç®¡ç†ï¼Œä¹Ÿå°±æ˜¯æœ¬ç‰©ç†ä¸»æœºç®¡ç†ï¼Œå› æ­¤æ§åˆ¶å™¨åªæ§åˆ¶è¿™ä¸€ä¸ªæ–°çš„ `Pod`ï¼Œè¿™ä¸ª `Pod` å†…éƒ¨è‡ªå¸¦ä¸€ä¸ª `agnhost` å®¹å™¨ã€‚

è¿™æ ·ä½œä¸ºå­¦ä¹ å’Œæµ‹è¯•çš„æˆ‘ä»¬ï¼Œå°±ä¸éœ€è¦æå‰æ­å»ºå†—ä½™çš„ `k8s` ç»„ä»¶ç¯å¢ƒï¼Œè€Œæ˜¯ç›´æ¥ä»æ§åˆ¶å™¨å’Œ `Pod` å¼€å§‹å­¦ä¹ ï¼Œè·³è¿‡å‰é¢å†—ä½™çš„é…ç½®ï¼Œç›´æ¥æ­¥å…¥ä¸»é¢˜ã€‚

### 3.4.7.minikube çš„æœåŠ¡å‘ç°

é»˜è®¤çš„ `Pod` åªèƒ½é€šè¿‡...

## 3.5.k8s çš„å­˜å‚¨çŠ¶æ€

`DBMS` å’Œ `LVS`

## 3.6.k8s çš„è°ƒåº¦ç®¡ç†



## 3.7.k8s çš„å®‰å…¨æœºåˆ¶



## 3.8.k8s çš„è½¯ä»¶ç®¡ç†



## 3.9.k8s çš„æºç æ¢ç©¶



# 4.é›†ç¾¤ç®¡ç†çš„æ–‡æ¡£ä»»åŠ¡

https://kubernetes.io/zh-cn/docs/tasks/



