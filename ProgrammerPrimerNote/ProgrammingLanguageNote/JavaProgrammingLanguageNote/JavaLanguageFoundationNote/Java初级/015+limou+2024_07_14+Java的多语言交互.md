

**叠甲：以下文章主要是依靠我的实际编码学习中总结出来的经验之谈，求逻辑自洽，不能百分百保证正确，有错误、未定义、不合适的内容请尽情指出！**

[TOC]

>   概要：...

>   资料：...

---

# 1.JNI

## 1.1.设置项目文件结构

假设您的项目结构如下所示，并且都为空白文件。

```shell
# 项目结构
project/
├── JNIDemo.java
├── JNIDemo.cpp
...
```

## 1.2.生成 Cpp 头文件

使用 `javah -jni JNIDemo` 工具生成 `Cpp` 头文件，生成的头文件 `JNIDemo.h` 会包含 `JNI` 函数签名。这个文件是用来规范 `Cpp` 程序员进行代码实现，`Cpp` 程序员需要根据这个头文件来进行源文件的实现。

```cpp
// JNIDemo.h
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h> // 这个头文件其实是 Java 官方提供的实现, 使得 Java 虚拟机能够与本地代码进行交互和通信
/* Header for class JNIDemo */

#ifndef _Included_JNIDemo // 头文件防护符
#define _Included_JNIDemo

#ifdef __cplusplus // 处理 C/Cpp 符号表规则不一的问题
extern "C" {
#endif
    
/*
 * Class:     JNIDemo
 * Method:    add
 * Signature: (II)I // 一种简化的函数签名表达, 参数为 (int, int), 返回值为 int
 */
JNIEXPORT jint JNICALL Java_JNIDemo_add
  (JNIEnv *, jobject, jint, jint);
    
// JNIEXPORT 宏用于标记一个函数是 JNI 的本地方法
// JNICALL 宏用于标记 JNI 方法的调用约定, 确保在不同平台上的兼容性
// 抽离上述的宏, 剩下的 jint Java_JNIDemo_add(JNIEnv *, jobject, jint, jint) 就是比较好理解的函数签名
    // 函数名中 Java 表示这是一个 JNI 方法; JNIDemo 表示指定了这个 JNI 方法属于哪个 Java 类; add 表示 Java 类中方法的名称
    // JNIEnv*: 是一个指向 JNI 环境的指针, 提供了访问 JNI API 的方法
    // jobject: 是一个指向调用 JNI 方法的 Java 对象的引用
    // jint: 	是 JNI 中定义的基本类型, 表示 Java 的 int 类型

#ifdef __cplusplus
}
#endif

#endif
```

>   补充：关于 `JNIEnv*` 和 `jobject` 的使用，待补充...

## 1.3.编写 Cpp 程序实现

```cpp
// JNIDemo.cpp
#include <jni.h>
#include "JNIDemo.h"

JNIEXPORT jint JNICALL Java_JNIDemo_add(JNIEnv *env, jobject obj, jint a, jint b) {
    return a + b;
}
```

## 1.4.生成本地 DLL 动态库

使用 `g++ -shared -o native.dll -I "%JAVA_HOME%\include" -I "%JAVA_HOME%\include\win32" JNIDemo.cpp` 编译 `Cpp` 源文件生成 `DLL` 动态库。

>   补充：在 `Linux` 中就是 `g++ -shared -fpic -o libnative.so -I${JAVA_HOME}/include -I${JAVA_HOME}/include/linux JNIDemo.cpp`，不过我没有尝试过，待补充...

## 1.5.编写 Java 程序逻辑

```java
// JNIDemo.java
public class JNIDemo {
    // 加载本地的库
    static {
        System.loadLibrary("native"); // 对应于 native.dll
    }
    
    // 声明本地方法
    public native int add(int a, int b);

    // 测试可否调用
    public static void main(String[] args) {
        JNIDemo demo = new JNIDemo();
        int result = demo.add(3, 4);
        System.out.println("Result: " + result);
    }
}
```

然后使用 `javac JNIDemo.java` 进行编译生成 `JNIDemo.class`。

## 1.6.运行 Java 程序

确保 `native.dll` 文件位于 `Java` 可加载的路径中（例如当前目录），然后使用 `java -Djava.library.path=. JNIDemo` 来运行 `Java` 程序。

# 2.JNA

这个 `JNA` 貌似性能要差一些，待补充...

---

>   结语：...