# 1.文档资料

1.   [科大讯飞/讯飞星火官网](https://xinghuo.xfyun.cn/sparkapi)
2.   [星火认知大模型 Web python 开发文档](https://www.xfyun.cn/doc/spark/Web.html#%E5%BF%AB%E9%80%9F%E8%B0%83%E7%94%A8%E9%9B%86%E6%88%90%E6%98%9F%E7%81%AB%E8%AE%A4%E7%9F%A5%E5%A4%A7%E6%A8%A1%E5%9E%8B%EF%BC%88python%E7%A4%BA%E4%BE%8B%EF%BC%89)
3.   [其他版本大模型 URL](https://www.xfyun.cn/doc/spark/Web.html)
4.   

# 2.快速使用

使用 `pip install --upgrade spark_ai_python` 安装开发库，注意该项目支持 `Python3.8+`，然后编写如下代码，根据文档购买 `token(1 tokens 约等于 1.5 个中文汉字或 0.8 个英文单词)` ，创建应用获取三个认证信息，最后编写如下代码。

```python
# 快速使用模型
from sparkai.llm.llm import ChatSparkLLM, ChunkPrintHandler
from sparkai.core.messages import ChatMessage

# 星火认知大模型 Spark3.5 Max 的 UR L值，其他版本大模型 URL 值请前往文档（https://www.xfyun.cn/doc/spark/Web.html）查看
SPARKAI_URL = 'wss://spark-api.xf-yun.com/v3.5/chat'
# 星火认知大模型调用秘钥信息，请前往讯飞开放平台控制台（https://console.xfyun.cn/services/bm35）查看
SPARKAI_APP_ID = '' # 需要自己填写
SPARKAI_API_SECRET = ''  # 需要自己填写
SPARKAI_API_KEY = ''  # 需要自己填写
# 星火认知大模型 Spark3.5 Max 的 domain 值，其他版本大模型 domain 值请前往文档（https://www.xfyun.cn/doc/spark/Web.html）查看
SPARKAI_DOMAIN = 'generalv3.5'

if __name__ == '__main__':
    spark = ChatSparkLLM(
        spark_api_url=SPARKAI_URL,
        spark_app_id=SPARKAI_APP_ID,
        spark_api_key=SPARKAI_API_KEY,
        spark_api_secret=SPARKAI_API_SECRET,
        spark_llm_domain=SPARKAI_DOMAIN,
        streaming=False,
    )
    messages = [ChatMessage(
        role="user",
        content='你好呀'
    )]
    handler = ChunkPrintHandler()
    a = spark.generate([messages], callbacks=[handler])
    print(a)
```

星火大模型 API 当前有 Lite、V2.0、Pro 和 Max 四个版本，四个版本独立计量 tokens，传输协议使用 ws(s)，为提高安全性，强烈推荐 wss。

**Spark3.5 Max请求地址，对应的domain参数为generalv3.5：**

```text
wss://spark-api.xf-yun.com/v3.5/chat
```

**Spark Pro请求地址，对应的domain参数为generalv3：**

```text
wss://spark-api.xf-yun.com/v3.1/chat
```

**Spark V2.0请求地址，对应的domain参数为generalv2：**

```text
wss://spark-api.xf-yun.com/v2.1/chat
```

**Spark Lite请求地址，对应的domain参数为general：**

```text
wss://spark-api.xf-yun.com/v1.1/chat
```

# 3.相关细节

>   警告：当前 `Spark Pro/3.5 Max(推荐)` 支持函数调用 `(Function Calling)`，但是如果是别的领域或模型，则不支持 `function_call` 字段。

## 3.1.接口请求报文

```python
# 参数构造示例如下
{
    # 头部
    "header": {
        "app_id": "12345", # 应用appid，从开放平台控制台创建的应用中获取
        "uid": "12345"
    },

    # 参数
    "parameter": {
        "chat": {
            "domain": "generalv3.5", # 指定访问的领域, 对应不同的大模型, [general,generalv2,generalv3,generalv3.5]
            "temperature": 0.5, # 核采样阈值, 决定结果随机性, (0，1], 默认值 0.5
            "max_tokens": 1024, # 模型回答的 tokens 的最大长度, [1,8192], 默认为 4096
            # "top_k": int # 从k个候选中随机选择⼀个(非等概率), [1，6], 默认为 4
        }
    },

    # 载荷
    "payload": {
        # 消息
        "message": {
            "text": [
                {
                    "role": "system",  # 设置对话背景
                    "content": "你现在扮演李白，你豪情万丈，狂放不羁；接下来请用李白的口吻和用户对话。"
                } 
                {
                    "role": "user", # 表示用户的历史回答结果(上下文)
                    "content": "你是谁"
                }
                {
                    "role": "assistant", # 表示 AI 的历史回答结果(上下文)
                    "content": "....."
                }
                {
                    "role": "user", # 用户最新的一条问题, 如无需上下文, 可只传最新一条问题
                    "content": "你会做什么"
                }
            ]
        }

        # 方法
        "functions": {
            "text": [ # 列表中的元素是 json 格式, 每个元素中包含 name、description、parameters 三个属性
                {
                    # (1)函数名称
                    "name": "天气查询",
                    
                    # (2)功能描述
                    "description": "天气插件可以提供天气相关信息。你可以提供指定的地点信息、指定的时间点或者时间段信息，来精准检索到天气信息。",
                    
                    # (3)参数列表
                    "parameters":
                    {
                        # a.参数类型
                        "type": "object",
                        
                        # b.参数信息描述
                        "properties":
                        {
                            # location 参数
                            "location":
                            {
                                "type": "string", # 参数类型描述
                                "description": "地点，比如北京。" # 参数详细描述
                            },
                            
                            # date 参数
                            "date":
                            {
                                "type": "string", # 参数类型描述
                                "description": "日期。" # 参数详细描述
                            }
                        },
                        
                        # c.放回的参数列表
                        "required":
                        [
                            "location"
                        ]
                    }
                },
                {
                    # (1)函数名称
                    "name": "税率查询",
                    
                    # (2)功能描述
                    "description": "税率查询可以查询某个地方的个人所得税率情况。你可以提供指定的地点信息、指定的时间点，精准检索到所得税率。",
                    
                    # (3)参数列表
                    "parameters":
                    {
                        # a.参数类型
                        "type": "object",
                        
                        # b.参数信息描述
                        "properties": {
                            # location 参数
                            "location":
                            {
                                "type": "string",
                                "description": "地点，比如北京。"
                            },
                            
                            # date 参数
                            "date":
                            {
                                "type": "string",
                                "description": "日期。"
                            }
                        },
                        
                        # c.放回的参数列表
                        "required":
                        [
                            "location"
                        ]
                    }
                }
            ]
        }
    }
}
```

## 3.2.接口响应报文

```python
# 接口为流式返回，此示例为最后一次返回结果，开发者需要将接口多次返回的结果进行拼接展示
{
    # 头部
    "header": {
        "code": 0, # 错误码, 0 表示正常, 非 0 表示出错
        "message": "Success", # 会话是否成功的描述信息
        "sid": "cht000cb087@dx18793cd421fb894542", # 会话的唯一id, 用于讯飞技术人员查询服务端会话日志使用, 出现调用错误时建议留存该字段
        "status": 2 # 会话状态, 取值为 [0,1,2]; 0 代表首次结果; 1 代表中间结果; 2 代表最后一个结果
    },

    # 载荷
    "payload": {
        # 选择
        "choices": {
            "status": 2, # 文本响应状态, 取值为 [0,1,2]; 0 代表首个文本结果; 1 代表中间文本结果; 2 代表最后一个文本结果. 触发 function_call 的情况下，只会返回一帧结果
            "seq": 0, # 返回的数据序号，取值为 [0,9999999]
            "text": [
                {
                    "content": "我可以帮助你的吗？", # AI 的回答内容
                    "role": "assistant", # 角色标识, 固定为 assistant, 标识角色为 AI
                    "index": 0, # 结果序号, 取值为 [0,10]; 当前为保留字段, 开发者可忽略
                    "function_call":
                    {
                        "arguments": "{\"datetime\":\"今天\",\"location\":\"合肥\"}", # 客户在请求体中定义的参数及参数值
                        "name": "天气查询" # 客户在请求体中定义的方法名称
                    },
                }
            ]
        },

        # 用法
        "usage": {
            "text": {
                "question_tokens": 4, # 保留字段可忽略
                "prompt_tokens": 5, # 包含历史问题的总 tokens 大小
                "completion_tokens": 9, # 回答的 tokens 大小
                "total_tokens": 14 # prompt_tokens 和 completion_tokens 的和, 也是本次交互计费的 tokens 大小
            }
        }
    }
}

// 
"usage":{
    "text":{
        "question_tokens":3,
        "prompt_tokens":3,
        "completion_tokens":0,
        "total_tokens":3
    }
}
```



