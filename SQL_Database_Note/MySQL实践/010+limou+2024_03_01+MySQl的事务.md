>   前要：在网络服务中，如果对 `CURD` 不加限制，会出现什么问题？
>
>   在多个客户端同时向一个卖票服务器买票时（假设票数只剩一张），`A` 客户端让数据库内的票数 `count` 减 `1`，但是还没来得及更新数据，又有 `B` 服务器查询数据库，此时 `B` 服务器看到票数还是 `1`，又进行了减 `1` 操作，导致一张票被同时卖了两次。

`CURD` 的过程需要满足什么条件，才能解决上述问题呢？

1. 买票的过程得应该是原子操作（要么抢到，要么没抢）
2. 买票的过程中不能被相互影响（不能被互相影响，要割裂/独立开来）
3. 买完票后应该要永久有效（必须要做持久化，不能只是在内存中操作）
4. 买前和买后都是确定的状态（不能出现中间状态，要保证一致性）

# 1.事务的理解

## 1.1.事务的概念

事务简单来理解就是 **一组 DML 语句**，也就是一组用于数据操作（插入数据、删除数据...）的语句。

事务主要处理操作量大，复杂度高的数据，这些数据往往需要多条 `SQL` 语句来构成。

但是事务还不仅仅是多条语句的集合，还必须保证四个属性（`ACID`）才能保证安全运行事务：

-   **原子性(Atomicity)**：一组 `DML` 语句/一个事务，要么全部成功，要么全部失败，这是由 `MySQL` 提供的机制来保障的。

-   **一致性(Consistency)**：在事务开始和结束以后，数据库的完整性没有被破坏，写入的数据必须完全符合所有的预设规则（在 `MySQL` 中，一致性时被其他三个属性来保证的，但是需要数据库和用户来配合，才能得到一致性）

-   **隔离性(Isolation)**：防止多个事务并发执行时由于交叉执行导致的数据不一致问题，事务隔离有不同的等级

    (1)读未提交（`Read Uncommitted`）

    (2)读提交（`Read Committed`）

    (3)可重复读（`Repeatable Read`）

    (4)串行化（`Serialzable`）

-   **持久性(Durability)**：事务处理完后，对表中数据的影响是永久的（哪怕系统挂了也不会丢失），也就是持久化

>   注意：学习事务一定要在使用数据库的用户视角来理解。

事务在 `MySQL` 内也一定是一个具体对象，这就需要先描述再组织。

另外，事务不是 `MySQl` 天然就存在，而是为了在应用程序访问数据库的时候，能够简化编程模型，不需要考虑各种潜在并发问题、网络问题，用户只需要提交和回滚。因此，事务的本质是为了应用层服务的，而不是面向数据库内部。

## 1.2.事务的版本

`MySQL` 中只有使用了 `Innodb` 数据库引擎的数据库或数据表才可以支持事务，其他基本都不支持。

```sql
# 查看 MySQL 的引擎是否支持事务
show engines \G
*************************** 1. row ***************************
      Engine: InnoDB
     Support: DEFAULT
     Comment: Supports transactions, row-level locking, and foreign keys
Transactions: YES
          XA: YES
  Savepoints: YES
*************************** 2. row ***************************
      Engine: MRG_MYISAM
     Support: YES
     Comment: Collection of identical MyISAM tables
Transactions: NO
          XA: NO
  Savepoints: NO
*************************** 3. row ***************************
      Engine: MEMORY
     Support: YES
     Comment: Hash based, stored in memory, useful for temporary tables
Transactions: NO
          XA: NO
  Savepoints: NO
*************************** 4. row ***************************
      Engine: BLACKHOLE
     Support: YES
     Comment: /dev/null storage engine (anything you write to it disappears)
Transactions: NO
          XA: NO
  Savepoints: NO
*************************** 5. row ***************************
      Engine: MyISAM
     Support: YES
     Comment: MyISAM storage engine
Transactions: NO
          XA: NO
  Savepoints: NO
*************************** 6. row ***************************
      Engine: CSV
     Support: YES
     Comment: CSV storage engine
Transactions: NO
          XA: NO
  Savepoints: NO
*************************** 7. row ***************************
      Engine: ARCHIVE
     Support: YES
     Comment: Archive storage engine
Transactions: NO
          XA: NO
  Savepoints: NO
*************************** 8. row ***************************
      Engine: PERFORMANCE_SCHEMA
     Support: YES
     Comment: Performance Schema
Transactions: NO
          XA: NO
  Savepoints: NO
*************************** 9. row ***************************
      Engine: FEDERATED
     Support: NO
     Comment: Federated MySQL storage engine
Transactions: NULL
          XA: NULL
  Savepoints: NULL
9 rows in set (0.00 sec)
```

# 2.事务的操作

首先，事务有两种提交方式：

-   自动提交
-   手动提交

```sql
# 查看事务提交方式
mysql> show variables like 'autocommit';
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| autocommit    | ON    |
+---------------+-------+
1 row in set (0.01 sec)
```

可以用 `SET` 来改变 `MySQL` 的自动提交方式。

```sql
# 取消事务自动提交
mysql> set autocommit=0;
Query OK, 0 rows affected (0.00 sec)

mysql> show variables like 'autocommit';
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| autocommit    | OFF   |
+---------------+-------+
1 row in set (0.00 sec)

mysql> set autocommit=1;
Query OK, 0 rows affected (0.00 sec)

mysql> show variables like 'autocommit';
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| autocommit    | ON    |
+---------------+-------+
1 row in set (0.00 sec)
```

然后我们切换超级用户，使用 `netstat -nltp` 是一个用于显示网络连接、路由表和网络接口信息的命令行工具查看 `MySQL` 是否成功运行且占用端口号。

```cmd
# 查看网络状态
# netstat -nltp
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
 tcp6       0      0 :::3306                 :::*                    LISTEN      7404/mysqld         
```

准备一个银行用户表

# 3.事务的隔离



